'use strict';

/**
 * Case 1 Challenges
 *
 * The code in this module was written to support a recreation of the challenges
 * from Case 1 in Geniverse. The challenges are:
 *  Challenge 0: Match the phenotype of a visible test drake to that of a target drake
 *               (This challenge is not in Geniverse but it was deemed a useful addition.)
 *  Challenge 1: Match the phenotype of a hidden test drake to that of a target drake
 *  Challenge 2: Match the phenotype of three hidden test drakes to target drakes
 */
var challengeLabels = ['challenge-0', 'challenge-1', 'challenge-2'],
    challengeCount = challengeLabels.length,
    sexLabels = ['male', 'female'],
    organismAlleles = "a:h,b:h,a:C,b:C,a:a,b:a,a:B,b:B,a:D,b:D,a:T,b:t,a:rh,b:rh,a:Bog,b:Bog",
    hiddenAlleles = ['t', 'tk', 'h', 'c', 'a', 'b', 'd', 'bog', 'rh'];
var sexOfTargetDrake = void 0,
    targetDrake = void 0,
    sexOfYourDrake = void 0,
    yourDrake = void 0,
    requiredMoveCount = void 0,
    showDrakeForConfirmation = false,
    trialCount = 1,
    trialIndex = 1,
    moveCount = 0;

function parseQueryString(queryString) {
  var params = {},
      queries = void 0,
      tmp = void 0,
      i = void 0,
      l = void 0;

  // Split into key/value pairs
  queries = queryString.split('&');

  // Convert the array of strings into an object
  for (i = 0, l = queries.length; i < l; i++) {
    tmp = queries[i].split('=');
    params[tmp[0]] = tmp[1];
  }

  return params;
}

var urlParams = parseQueryString(window.location.search.substring(1)),
    challengeParam = urlParams.challenge && Number(urlParams.challenge),
    challenge = challengeParam >= 0 && challengeParam < challengeCount ? challengeParam : 0;

if (challenge >= 2) trialCount = 3;

function resetDrakes() {
  requiredMoveCount = 0;
  // regenerate if we generate drakes that are too close to each other
  while (requiredMoveCount < 3) {
    sexOfTargetDrake = Math.floor(2 * Math.random());
    targetDrake = new BioLogica.Organism(BioLogica.Species.Drake, organismAlleles, sexOfTargetDrake);
    sexOfYourDrake = Math.floor(2 * Math.random());
    yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, organismAlleles, sexOfYourDrake);
    // add one for clicking the "Check Drake" button
    requiredMoveCount = GeniBlocks.GeneticsUtils.numberOfChangesToReachPhenotype(yourDrake, targetDrake) + 1;
  }
  render();
}

function render() {
  // target drake
  ReactDOM.render(React.createElement(GeniBlocks.OrganismGlowView, { org: targetDrake, color: '#FFFFAA', size: 200 }), document.getElementById('target-drake'));

  // trial feedback
  ReactDOM.render(React.createElement(GeniBlocks.FeedbackView, {
    text: ["TRIAL", trialIndex + ' of ' + trialCount]
  }), document.getElementById('trial-feedback'));

  // goal feedback
  ReactDOM.render(React.createElement(GeniBlocks.FeedbackView, {
    text: ['GOAL is ' + requiredMoveCount + ' MOVES', 'Your moves: ' + moveCount]
  }), document.getElementById('goal-feedback'));

  // your drake
  ReactDOM.render(React.createElement(GeniBlocks.QuestionOrganismGlowView, { hidden: challenge > 0 && !showDrakeForConfirmation,
    org: yourDrake, color: '#FFFFAA', size: 200 }), document.getElementById('your-drake'));
  // ReactDOM.render(
  //   React.createElement(GeniBlocks.HidableOrganismGlowView,
  //                       {hidden: true, org: yourDrake, color: '#FFFFAA', size: 200}),
  //   document.getElementById('your-drake'));

  // change sex buttons
  ReactDOM.render(React.createElement(GeniBlocks.ChangeSexButtons, {
    sex: sexLabels[sexOfYourDrake],
    species: "Drake",
    onChange: function onChange(evt, iSex) {
      // replace alleles lost when switching to male and back
      var alleleString = GeniBlocks.GeneticsUtils.fillInMissingAllelesFromAlleleString(yourDrake.genetics, yourDrake.getAlleleString(), organismAlleles);
      sexOfYourDrake = sexLabels.indexOf(iSex);
      yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, alleleString, sexOfYourDrake);
      ++moveCount;
      render();
    }
  }), document.getElementById('change-sex-buttons'));

  // genome
  ReactDOM.render(React.createElement(GeniBlocks.GenomeView, {
    org: yourDrake,
    hiddenAlleles: hiddenAlleles,
    style: { marginTop: 50, top: 50 },
    alleleChanged: function alleleChanged(chrom, side, prevAllele, newAllele) {
      yourDrake.genetics.genotype.replaceAlleleChromName(chrom, side, prevAllele, newAllele);
      yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, yourDrake.getAlleleString(), sexOfYourDrake);
      ++moveCount;
      render();
    }
  }), document.getElementById('drake-genome'));
}

function resetChallenge() {
  trialIndex = 1;
  moveCount = 0;
  resetDrakes();
}

function nextChallenge() {
  var url = window.location.href,
      nextUrl = void 0;
  if (challenge < 2) {
    // advance to next challenge
    nextUrl = url.replace('challenge=' + challenge, 'challenge=' + (challenge + 1));
  } else {
    // back to case log
    var case1Index = url.indexOf('case-1');
    nextUrl = url.substr(0, case1Index);
  }
  window.location.assign(nextUrl);
}

function advanceTrial() {
  if (challenge >= 2) {
    if (trialIndex >= trialCount) {
      showAlert(true, {
        title: "Congratulations!",
        message: "You've completed all the trials in this challenge.",
        okButton: "Go back to the Case Log",
        okCallback: nextChallenge,
        tryButton: "Try Again",
        tryCallback: resetChallenge
      });
      return;
    }
    ++trialIndex;
  }
  moveCount = 0;
  resetDrakes();
}

var alertClientButtonClickHandlers = {};
function showAlert(iShow, iOptions) {
  var displayMode = iShow ? 'block' : 'none',
      okButton = document.getElementById("alert-ok-button"),
      tryButton = document.getElementById("alert-try-button");
  if (iShow) {
    document.getElementById("alert-title").innerHTML = iOptions.title || "";
    document.getElementById("alert-message").innerHTML = iOptions.message || "";
    okButton.innerHTML = iOptions.okButton || "";
    okButton.style.display = iOptions.okButton ? 'block' : 'none';
    okButton.dataset.okCallback = iOptions.okCallback || '';
    alertClientButtonClickHandlers[okButton.id] = iOptions.okCallback || null;
    tryButton.innerHTML = iOptions.tryButton || "";
    tryButton.style.display = iOptions.tryButton ? 'block' : 'none';
    alertClientButtonClickHandlers[tryButton.id] = iOptions.tryCallback || null;
  } else {
    alertClientButtonClickHandlers[okButton.id] = null;
    alertClientButtonClickHandlers[tryButton.id] = null;
  }
  document.getElementById("overlay").style.display = displayMode;
  document.getElementById("alert-wrapper").style.display = displayMode;
}

document.getElementById("test-drake-button").onclick = function () {
  // Checking the answer counts as a move
  ++moveCount;
  showDrakeForConfirmation = true;
  render();

  if (0 === GeniBlocks.GeneticsUtils.numberOfChangesToReachPhenotype(yourDrake, targetDrake)) {
    if (challenge <= 1) {
      showAlert(true, {
        title: "Good work!",
        message: "The drake you have created matches the target drake.",
        okButton: "Next Challenge",
        okCallback: nextChallenge,
        tryButton: "Try Again",
        tryCallback: resetChallenge
      });
    } else {
      showAlert(true, {
        title: "Good work!",
        message: "The drake you have created matches the target drake.",
        okButton: "OK",
        okCallback: advanceTrial
      });
    }
  } else {
    showAlert(true, {
      title: "That's not the drake!",
      message: "The drake you have created doesn't match the target drake.\nPlease try again.",
      tryButton: "Try Again"
    });
    render();
  }
};

function alertButtonClickHandler(evt) {
  var clientClickHandler = alertClientButtonClickHandlers[evt.target.id];
  showAlert(false);
  showDrakeForConfirmation = false;
  if (clientClickHandler) clientClickHandler();
  render();
}

document.getElementById("alert-ok-button").onclick = alertButtonClickHandler;
document.getElementById("alert-try-button").onclick = alertButtonClickHandler;

resetDrakes();
//# sourceMappingURL=data:application/json;base64,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LElBQVYsRUFBZ0I7QUFDRSxhQUFPLHVCQUFQO0FBQ0EsZUFBUywrRUFBVDtBQUNBLGlCQUFXLFdBQVg7S0FIbEIsRUFERztBQU1ILGFBTkc7R0FwQkw7Q0FOcUQ7O0FBb0N2RCxTQUFTLHVCQUFULENBQWlDLEdBQWpDLEVBQXNDO0FBQ3BDLE1BQU0scUJBQXFCLCtCQUErQixJQUFJLE1BQUosQ0FBVyxFQUFYLENBQXBELENBRDhCO0FBRXBDLFlBQVUsS0FBVixFQUZvQztBQUdwQyw2QkFBMkIsS0FBM0IsQ0FIb0M7QUFJcEMsTUFBSSxrQkFBSixFQUNFLHFCQURGO0FBRUEsV0FOb0M7Q0FBdEM7O0FBU0EsU0FBUyxjQUFULENBQXdCLGlCQUF4QixFQUEyQyxPQUEzQyxHQUFxRCx1QkFBckQ7QUFDQSxTQUFTLGNBQVQsQ0FBd0Isa0JBQXhCLEVBQTRDLE9BQTVDLEdBQXNELHVCQUF0RDs7QUFFQSIsImZpbGUiOiJjYXNlLTEvY2hhbGxlbmdlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ2FzZSAxIENoYWxsZW5nZXNcbiAqXG4gKiBUaGUgY29kZSBpbiB0aGlzIG1vZHVsZSB3YXMgd3JpdHRlbiB0byBzdXBwb3J0IGEgcmVjcmVhdGlvbiBvZiB0aGUgY2hhbGxlbmdlc1xuICogZnJvbSBDYXNlIDEgaW4gR2VuaXZlcnNlLiBUaGUgY2hhbGxlbmdlcyBhcmU6XG4gKiAgQ2hhbGxlbmdlIDA6IE1hdGNoIHRoZSBwaGVub3R5cGUgb2YgYSB2aXNpYmxlIHRlc3QgZHJha2UgdG8gdGhhdCBvZiBhIHRhcmdldCBkcmFrZVxuICogICAgICAgICAgICAgICAoVGhpcyBjaGFsbGVuZ2UgaXMgbm90IGluIEdlbml2ZXJzZSBidXQgaXQgd2FzIGRlZW1lZCBhIHVzZWZ1bCBhZGRpdGlvbi4pXG4gKiAgQ2hhbGxlbmdlIDE6IE1hdGNoIHRoZSBwaGVub3R5cGUgb2YgYSBoaWRkZW4gdGVzdCBkcmFrZSB0byB0aGF0IG9mIGEgdGFyZ2V0IGRyYWtlXG4gKiAgQ2hhbGxlbmdlIDI6IE1hdGNoIHRoZSBwaGVub3R5cGUgb2YgdGhyZWUgaGlkZGVuIHRlc3QgZHJha2VzIHRvIHRhcmdldCBkcmFrZXNcbiAqL1xuY29uc3QgY2hhbGxlbmdlTGFiZWxzID0gWydjaGFsbGVuZ2UtMCcsICdjaGFsbGVuZ2UtMScsICdjaGFsbGVuZ2UtMiddLFxuICAgICAgY2hhbGxlbmdlQ291bnQgPSBjaGFsbGVuZ2VMYWJlbHMubGVuZ3RoLFxuICAgICAgc2V4TGFiZWxzID0gWydtYWxlJywgJ2ZlbWFsZSddLFxuICAgICAgb3JnYW5pc21BbGxlbGVzID0gXCJhOmgsYjpoLGE6QyxiOkMsYTphLGI6YSxhOkIsYjpCLGE6RCxiOkQsYTpULGI6dCxhOnJoLGI6cmgsYTpCb2csYjpCb2dcIixcbiAgICAgIGhpZGRlbkFsbGVsZXMgPSBbJ3QnLCd0aycsJ2gnLCdjJywnYScsJ2InLCdkJywnYm9nJywncmgnXTtcbmxldCAgIHNleE9mVGFyZ2V0RHJha2UsXG4gICAgICB0YXJnZXREcmFrZSxcbiAgICAgIHNleE9mWW91ckRyYWtlLFxuICAgICAgeW91ckRyYWtlLFxuICAgICAgcmVxdWlyZWRNb3ZlQ291bnQsXG4gICAgICBzaG93RHJha2VGb3JDb25maXJtYXRpb24gPSBmYWxzZSxcbiAgICAgIHRyaWFsQ291bnQgPSAxLFxuICAgICAgdHJpYWxJbmRleCA9IDEsXG4gICAgICBtb3ZlQ291bnQgPSAwO1xuXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5U3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9LCBxdWVyaWVzLCB0bXAsIGksIGw7XG5cbiAgICAvLyBTcGxpdCBpbnRvIGtleS92YWx1ZSBwYWlyc1xuICAgIHF1ZXJpZXMgPSBxdWVyeVN0cmluZy5zcGxpdCgnJicpO1xuXG4gICAgLy8gQ29udmVydCB0aGUgYXJyYXkgb2Ygc3RyaW5ncyBpbnRvIGFuIG9iamVjdFxuICAgIGZvciAoIGkgPSAwLCBsID0gcXVlcmllcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7XG4gICAgICAgIHRtcCA9IHF1ZXJpZXNbaV0uc3BsaXQoJz0nKTtcbiAgICAgICAgcGFyYW1zW3RtcFswXV0gPSB0bXBbMV07XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmFtcztcbn1cblxubGV0IHVybFBhcmFtcyA9IHBhcnNlUXVlcnlTdHJpbmcoKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpLnN1YnN0cmluZygxKSksXG4gICAgY2hhbGxlbmdlUGFyYW0gPSB1cmxQYXJhbXMuY2hhbGxlbmdlICYmIE51bWJlcih1cmxQYXJhbXMuY2hhbGxlbmdlKSxcbiAgICBjaGFsbGVuZ2UgPSAoY2hhbGxlbmdlUGFyYW0gPj0gMCkgJiYgKGNoYWxsZW5nZVBhcmFtIDwgY2hhbGxlbmdlQ291bnQpID8gY2hhbGxlbmdlUGFyYW0gOiAwO1xuXG5pZiAoY2hhbGxlbmdlID49IDIpXG4gIHRyaWFsQ291bnQgPSAzO1xuXG5mdW5jdGlvbiByZXNldERyYWtlcygpIHtcbiAgcmVxdWlyZWRNb3ZlQ291bnQgPSAwO1xuICAvLyByZWdlbmVyYXRlIGlmIHdlIGdlbmVyYXRlIGRyYWtlcyB0aGF0IGFyZSB0b28gY2xvc2UgdG8gZWFjaCBvdGhlclxuICB3aGlsZSAocmVxdWlyZWRNb3ZlQ291bnQgPCAzKSB7XG4gICAgc2V4T2ZUYXJnZXREcmFrZSA9IE1hdGguZmxvb3IoMiAqIE1hdGgucmFuZG9tKCkpO1xuICAgIHRhcmdldERyYWtlID0gbmV3IEJpb0xvZ2ljYS5PcmdhbmlzbShCaW9Mb2dpY2EuU3BlY2llcy5EcmFrZSwgb3JnYW5pc21BbGxlbGVzLCBzZXhPZlRhcmdldERyYWtlKTtcbiAgICBzZXhPZllvdXJEcmFrZSA9IE1hdGguZmxvb3IoMiAqIE1hdGgucmFuZG9tKCkpO1xuICAgIHlvdXJEcmFrZSA9IG5ldyBCaW9Mb2dpY2EuT3JnYW5pc20oQmlvTG9naWNhLlNwZWNpZXMuRHJha2UsIG9yZ2FuaXNtQWxsZWxlcywgc2V4T2ZZb3VyRHJha2UpO1xuICAgIC8vIGFkZCBvbmUgZm9yIGNsaWNraW5nIHRoZSBcIkNoZWNrIERyYWtlXCIgYnV0dG9uXG4gICAgcmVxdWlyZWRNb3ZlQ291bnQgPSBHZW5pQmxvY2tzLkdlbmV0aWNzVXRpbHMuXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlck9mQ2hhbmdlc1RvUmVhY2hQaGVub3R5cGUoeW91ckRyYWtlLCB0YXJnZXREcmFrZSkgKyAxO1xuICB9XG4gIHJlbmRlcigpO1xufVxuXG5mdW5jdGlvbiByZW5kZXIoKSB7XG4gIC8vIHRhcmdldCBkcmFrZVxuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLk9yZ2FuaXNtR2xvd1ZpZXcsIHtvcmc6IHRhcmdldERyYWtlLCBjb2xvcjogJyNGRkZGQUEnLCBzaXplOiAyMDB9KSxcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFyZ2V0LWRyYWtlJykpO1xuXG4gIC8vIHRyaWFsIGZlZWRiYWNrXG4gIFJlYWN0RE9NLnJlbmRlcihcbiAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuRmVlZGJhY2tWaWV3LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlRSSUFMXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7dHJpYWxJbmRleH0gb2YgJHt0cmlhbENvdW50fWBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RyaWFsLWZlZWRiYWNrJykpO1xuXG4gIC8vIGdvYWwgZmVlZGJhY2tcbiAgUmVhY3RET00ucmVuZGVyKFxuICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoR2VuaUJsb2Nrcy5GZWVkYmFja1ZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBHT0FMIGlzICR7cmVxdWlyZWRNb3ZlQ291bnR9IE1PVkVTYCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgWW91ciBtb3ZlczogJHttb3ZlQ291bnR9YFxuICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29hbC1mZWVkYmFjaycpKTtcblxuICAvLyB5b3VyIGRyYWtlXG4gIFJlYWN0RE9NLnJlbmRlcihcbiAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuUXVlc3Rpb25PcmdhbmlzbUdsb3dWaWV3LFxuICAgICAgICAgICAgICAgICAgICAgICAge2hpZGRlbjogKGNoYWxsZW5nZSA+IDApICYmICFzaG93RHJha2VGb3JDb25maXJtYXRpb24sIFxuICAgICAgICAgICAgICAgICAgICAgICAgICBvcmc6IHlvdXJEcmFrZSwgY29sb3I6ICcjRkZGRkFBJywgc2l6ZTogMjAwfSksXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3lvdXItZHJha2UnKSk7XG4gIC8vIFJlYWN0RE9NLnJlbmRlcihcbiAgLy8gICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuSGlkYWJsZU9yZ2FuaXNtR2xvd1ZpZXcsXG4gIC8vICAgICAgICAgICAgICAgICAgICAgICB7aGlkZGVuOiB0cnVlLCBvcmc6IHlvdXJEcmFrZSwgY29sb3I6ICcjRkZGRkFBJywgc2l6ZTogMjAwfSksXG4gIC8vICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3lvdXItZHJha2UnKSk7XG5cbiAgLy8gY2hhbmdlIHNleCBidXR0b25zXG4gIFJlYWN0RE9NLnJlbmRlcihcbiAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuQ2hhbmdlU2V4QnV0dG9ucywge1xuICAgICAgICAgIHNleDogc2V4TGFiZWxzW3NleE9mWW91ckRyYWtlXSxcbiAgICAgICAgICBzcGVjaWVzOiBcIkRyYWtlXCIsXG4gICAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGV2dCwgaVNleCkge1xuICAgICAgICAgICAgLy8gcmVwbGFjZSBhbGxlbGVzIGxvc3Qgd2hlbiBzd2l0Y2hpbmcgdG8gbWFsZSBhbmQgYmFja1xuICAgICAgICAgICAgY29uc3QgYWxsZWxlU3RyaW5nID0gR2VuaUJsb2Nrcy5HZW5ldGljc1V0aWxzLmZpbGxJbk1pc3NpbmdBbGxlbGVzRnJvbUFsbGVsZVN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3VyRHJha2UuZ2VuZXRpY3MsIHlvdXJEcmFrZS5nZXRBbGxlbGVTdHJpbmcoKSwgb3JnYW5pc21BbGxlbGVzKTtcbiAgICAgICAgICAgIHNleE9mWW91ckRyYWtlID0gc2V4TGFiZWxzLmluZGV4T2YoaVNleCk7XG4gICAgICAgICAgICB5b3VyRHJha2UgPSBuZXcgQmlvTG9naWNhLk9yZ2FuaXNtKEJpb0xvZ2ljYS5TcGVjaWVzLkRyYWtlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsZWxlU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V4T2ZZb3VyRHJha2UpO1xuICAgICAgICAgICAgKyttb3ZlQ291bnQ7XG4gICAgICAgICAgICByZW5kZXIoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFuZ2Utc2V4LWJ1dHRvbnMnKVxuICApO1xuXG4gIC8vIGdlbm9tZVxuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLkdlbm9tZVZpZXcsIHtcbiAgICAgIG9yZzogeW91ckRyYWtlLFxuICAgICAgaGlkZGVuQWxsZWxlczogaGlkZGVuQWxsZWxlcyxcbiAgICAgIHN0eWxlOiB7bWFyZ2luVG9wOiA1MCwgdG9wOiA1MH0sXG4gICAgICBhbGxlbGVDaGFuZ2VkOiBmdW5jdGlvbihjaHJvbSwgc2lkZSwgcHJldkFsbGVsZSwgbmV3QWxsZWxlKSB7XG4gICAgICAgIHlvdXJEcmFrZS5nZW5ldGljcy5nZW5vdHlwZS5yZXBsYWNlQWxsZWxlQ2hyb21OYW1lKGNocm9tLCBzaWRlLCBwcmV2QWxsZWxlLCBuZXdBbGxlbGUpO1xuICAgICAgICB5b3VyRHJha2UgPSBuZXcgQmlvTG9naWNhLk9yZ2FuaXNtKEJpb0xvZ2ljYS5TcGVjaWVzLkRyYWtlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3VyRHJha2UuZ2V0QWxsZWxlU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNleE9mWW91ckRyYWtlKTtcbiAgICAgICAgKyttb3ZlQ291bnQ7XG4gICAgICAgIHJlbmRlcigpO1xuICAgICAgfVxuICAgIH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmFrZS1nZW5vbWUnKVxuICApO1xuXG59XG5cbmZ1bmN0aW9uIHJlc2V0Q2hhbGxlbmdlKCkge1xuICB0cmlhbEluZGV4ID0gMTtcbiAgbW92ZUNvdW50ID0gMDtcbiAgcmVzZXREcmFrZXMoKTtcbn1cblxuZnVuY3Rpb24gbmV4dENoYWxsZW5nZSgpIHtcbiAgbGV0IHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLFxuICAgICAgbmV4dFVybDtcbiAgaWYgKGNoYWxsZW5nZSA8IDIpIHtcbiAgICAvLyBhZHZhbmNlIHRvIG5leHQgY2hhbGxlbmdlXG4gICAgbmV4dFVybCA9IHVybC5yZXBsYWNlKGBjaGFsbGVuZ2U9JHtjaGFsbGVuZ2V9YCwgYGNoYWxsZW5nZT0ke2NoYWxsZW5nZSsxfWApO1xuICB9XG4gIGVsc2Uge1xuICAgIC8vIGJhY2sgdG8gY2FzZSBsb2dcbiAgICBjb25zdCBjYXNlMUluZGV4ID0gdXJsLmluZGV4T2YoJ2Nhc2UtMScpO1xuICAgIG5leHRVcmwgPSB1cmwuc3Vic3RyKDAsIGNhc2UxSW5kZXgpO1xuICB9XG4gIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24obmV4dFVybCk7XG59XG5cbmZ1bmN0aW9uIGFkdmFuY2VUcmlhbCgpIHtcbiAgaWYgKGNoYWxsZW5nZSA+PSAyKSB7XG4gICAgaWYgKHRyaWFsSW5kZXggPj0gdHJpYWxDb3VudCkge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIkNvbmdyYXR1bGF0aW9ucyFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiWW91J3ZlIGNvbXBsZXRlZCBhbGwgdGhlIHRyaWFscyBpbiB0aGlzIGNoYWxsZW5nZS5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uOiBcIkdvIGJhY2sgdG8gdGhlIENhc2UgTG9nXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0NhbGxiYWNrOiBuZXh0Q2hhbGxlbmdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5QnV0dG9uOiBcIlRyeSBBZ2FpblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q2FsbGJhY2s6IHJlc2V0Q2hhbGxlbmdlXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgICsrdHJpYWxJbmRleDtcbiAgfVxuICBtb3ZlQ291bnQgPSAwO1xuICByZXNldERyYWtlcygpO1xufVxuXG5sZXQgYWxlcnRDbGllbnRCdXR0b25DbGlja0hhbmRsZXJzID0ge307XG5mdW5jdGlvbiBzaG93QWxlcnQoaVNob3csIGlPcHRpb25zKSB7XG4gIGNvbnN0IGRpc3BsYXlNb2RlID0gaVNob3cgPyAnYmxvY2snIDogJ25vbmUnLFxuICAgICAgICBva0J1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtb2stYnV0dG9uXCIpLFxuICAgICAgICB0cnlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LXRyeS1idXR0b25cIik7XG4gIGlmIChpU2hvdykge1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtdGl0bGVcIikuaW5uZXJIVE1MID0gaU9wdGlvbnMudGl0bGUgfHwgXCJcIjtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LW1lc3NhZ2VcIikuaW5uZXJIVE1MID0gaU9wdGlvbnMubWVzc2FnZSB8fCBcIlwiO1xuICAgIG9rQnV0dG9uLmlubmVySFRNTCA9IGlPcHRpb25zLm9rQnV0dG9uIHx8IFwiXCI7XG4gICAgb2tCdXR0b24uc3R5bGUuZGlzcGxheSA9IGlPcHRpb25zLm9rQnV0dG9uID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgICBva0J1dHRvbi5kYXRhc2V0Lm9rQ2FsbGJhY2sgPSBpT3B0aW9ucy5va0NhbGxiYWNrIHx8ICcnO1xuICAgIGFsZXJ0Q2xpZW50QnV0dG9uQ2xpY2tIYW5kbGVyc1tva0J1dHRvbi5pZF0gPSBpT3B0aW9ucy5va0NhbGxiYWNrIHx8IG51bGw7XG4gICAgdHJ5QnV0dG9uLmlubmVySFRNTCA9IGlPcHRpb25zLnRyeUJ1dHRvbiB8fCBcIlwiO1xuICAgIHRyeUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gaU9wdGlvbnMudHJ5QnV0dG9uID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgICBhbGVydENsaWVudEJ1dHRvbkNsaWNrSGFuZGxlcnNbdHJ5QnV0dG9uLmlkXSA9IGlPcHRpb25zLnRyeUNhbGxiYWNrIHx8IG51bGw7XG4gIH1cbiAgZWxzZSB7XG4gICAgYWxlcnRDbGllbnRCdXR0b25DbGlja0hhbmRsZXJzW29rQnV0dG9uLmlkXSA9IG51bGw7XG4gICAgYWxlcnRDbGllbnRCdXR0b25DbGlja0hhbmRsZXJzW3RyeUJ1dHRvbi5pZF0gPSBudWxsO1xuICB9XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwib3ZlcmxheVwiKS5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheU1vZGU7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtd3JhcHBlclwiKS5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheU1vZGU7XG59XG5cbmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdC1kcmFrZS1idXR0b25cIikub25jbGljayA9IGZ1bmN0aW9uKCkge1xuICAvLyBDaGVja2luZyB0aGUgYW5zd2VyIGNvdW50cyBhcyBhIG1vdmVcbiAgKyttb3ZlQ291bnQ7XG4gIHNob3dEcmFrZUZvckNvbmZpcm1hdGlvbiA9IHRydWU7XG4gIHJlbmRlcigpO1xuXG4gIGlmICgwID09PSBHZW5pQmxvY2tzLkdlbmV0aWNzVXRpbHMubnVtYmVyT2ZDaGFuZ2VzVG9SZWFjaFBoZW5vdHlwZSh5b3VyRHJha2UsIHRhcmdldERyYWtlKSkge1xuICAgIGlmIChjaGFsbGVuZ2UgPD0gMSkge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJHb29kIHdvcmshXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlRoZSBkcmFrZSB5b3UgaGF2ZSBjcmVhdGVkIG1hdGNoZXMgdGhlIHRhcmdldCBkcmFrZS5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uOiBcIk5leHQgQ2hhbGxlbmdlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0NhbGxiYWNrOiBuZXh0Q2hhbGxlbmdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5QnV0dG9uOiBcIlRyeSBBZ2FpblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q2FsbGJhY2s6IHJlc2V0Q2hhbGxlbmdlXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJHb29kIHdvcmshXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlRoZSBkcmFrZSB5b3UgaGF2ZSBjcmVhdGVkIG1hdGNoZXMgdGhlIHRhcmdldCBkcmFrZS5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uOiBcIk9LXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0NhbGxiYWNrOiBhZHZhbmNlVHJpYWxcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgc2hvd0FsZXJ0KHRydWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJUaGF0J3Mgbm90IHRoZSBkcmFrZSFcIixcbiAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlRoZSBkcmFrZSB5b3UgaGF2ZSBjcmVhdGVkIGRvZXNuJ3QgbWF0Y2ggdGhlIHRhcmdldCBkcmFrZS5cXG5QbGVhc2UgdHJ5IGFnYWluLlwiLFxuICAgICAgICAgICAgICAgICAgICAgIHRyeUJ1dHRvbjogXCJUcnkgQWdhaW5cIlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICByZW5kZXIoKTtcbiAgfVxufTtcblxuZnVuY3Rpb24gYWxlcnRCdXR0b25DbGlja0hhbmRsZXIoZXZ0KSB7XG4gIGNvbnN0IGNsaWVudENsaWNrSGFuZGxlciA9IGFsZXJ0Q2xpZW50QnV0dG9uQ2xpY2tIYW5kbGVyc1tldnQudGFyZ2V0LmlkXTtcbiAgc2hvd0FsZXJ0KGZhbHNlKTtcbiAgc2hvd0RyYWtlRm9yQ29uZmlybWF0aW9uID0gZmFsc2U7XG4gIGlmIChjbGllbnRDbGlja0hhbmRsZXIpXG4gICAgY2xpZW50Q2xpY2tIYW5kbGVyKCk7XG4gIHJlbmRlcigpO1xufVxuXG5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LW9rLWJ1dHRvblwiKS5vbmNsaWNrID0gYWxlcnRCdXR0b25DbGlja0hhbmRsZXI7XG5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LXRyeS1idXR0b25cIikub25jbGljayA9IGFsZXJ0QnV0dG9uQ2xpY2tIYW5kbGVyO1xuXG5yZXNldERyYWtlcygpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
