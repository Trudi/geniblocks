'use strict';

/**
 * Case 1 Challenges
 *
 * The code in this module was written to support a recreation of the challenges
 * from Case 1 in Geniverse. The challenges are:
 *  Challenge 0: Match the phenotype of a visible test drake to that of a target drake
 *               (This challenge is not in Geniverse but it was deemed a useful addition.)
 *  Challenge 1: Match the phenotype of a hidden test drake to that of a target drake
 *  Challenge 2: Match the phenotype of three hidden test drakes to target drakes
 */
var challengeLabels = ['challenge-0', 'challenge-1', 'challenge-2'],
    challengeCount = challengeLabels.length,
    sexLabels = ['male', 'female'],
    organismAlleles = "a:h,b:h,a:C,b:C,a:a,b:a,a:B,b:B,a:D,b:D,a:T,b:t,a:rh,b:rh,a:Bog,b:Bog",
    hiddenAlleles = ['t', 'tk', 'h', 'c', 'a', 'b', 'd', 'bog', 'rh'];
var sexOfTargetDrake = undefined,
    targetDrake = undefined,
    sexOfYourDrake = undefined,
    yourDrake = undefined,
    requiredMoveCount = undefined,
    showDrakeForConfirmation = false,
    trialCount = 1,
    trialIndex = 1,
    moveCount = 0;

function parseQueryString(queryString) {
  var params = {},
      queries = undefined,
      tmp = undefined,
      i = undefined,
      l = undefined;

  // Split into key/value pairs
  queries = queryString.split('&');

  // Convert the array of strings into an object
  for (i = 0, l = queries.length; i < l; i++) {
    tmp = queries[i].split('=');
    params[tmp[0]] = tmp[1];
  }

  return params;
}

var urlParams = parseQueryString(window.location.search.substring(1)),
    challengeParam = urlParams.challenge && Number(urlParams.challenge),
    challenge = challengeParam >= 0 && challengeParam < challengeCount ? challengeParam : 0;

if (challenge >= 2) trialCount = 3;

function resetDrakes() {
  requiredMoveCount = 0;
  // regenerate if we generate drakes that are too close to each other
  while (requiredMoveCount < 3) {
    sexOfTargetDrake = Math.floor(2 * Math.random());
    targetDrake = new BioLogica.Organism(BioLogica.Species.Drake, organismAlleles, sexOfTargetDrake);
    sexOfYourDrake = Math.floor(2 * Math.random());
    yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, organismAlleles, sexOfYourDrake);
    // add one for clicking the "Check Drake" button
    requiredMoveCount = GeniBlocks.GeneticsUtils.numberOfChangesToReachPhenotype(yourDrake, targetDrake) + 1;
  }
  render();
}

function render() {
  // target drake
  ReactDOM.render(React.createElement(GeniBlocks.OrganismGlowView, { org: targetDrake, color: '#FFFFAA', size: 200 }), document.getElementById('target-drake'));

  // trial feedback
  ReactDOM.render(React.createElement(GeniBlocks.FeedbackView, {
    text: ["TRIAL", trialIndex + ' of ' + trialCount]
  }), document.getElementById('trial-feedback'));

  // goal feedback
  ReactDOM.render(React.createElement(GeniBlocks.FeedbackView, {
    text: ['GOAL is ' + requiredMoveCount + ' MOVES', 'Your moves: ' + moveCount]
  }), document.getElementById('goal-feedback'));

  // your drake
  ReactDOM.render(React.createElement(GeniBlocks.QuestionOrganismGlowView, { hidden: challenge > 0 && !showDrakeForConfirmation,
    org: yourDrake, color: '#FFFFAA', size: 200 }), document.getElementById('your-drake'));
  // ReactDOM.render(
  //   React.createElement(GeniBlocks.HidableOrganismGlowView,
  //                       {hidden: true, org: yourDrake, color: '#FFFFAA', size: 200}),
  //   document.getElementById('your-drake'));

  // change sex buttons
  ReactDOM.render(React.createElement(GeniBlocks.ChangeSexButtons, {
    sex: sexLabels[sexOfYourDrake],
    species: "Drake",
    onChange: function onChange(evt, iSex) {
      // replace alleles lost when switching to male and back
      var alleleString = GeniBlocks.GeneticsUtils.fillInMissingAllelesFromAlleleString(yourDrake.genetics, yourDrake.getAlleleString(), organismAlleles);
      sexOfYourDrake = sexLabels.indexOf(iSex);
      yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, alleleString, sexOfYourDrake);
      ++moveCount;
      render();
    }
  }), document.getElementById('change-sex-buttons'));

  // genome
  ReactDOM.render(React.createElement(GeniBlocks.GenomeView, {
    org: yourDrake,
    hiddenAlleles: hiddenAlleles,
    style: { marginTop: 50, top: 50 },
    alleleChanged: function alleleChanged(chrom, side, prevAllele, newAllele) {
      yourDrake.genetics.genotype.chromosomes[chrom][side].alleles.replaceFirst(prevAllele, newAllele);
      yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, yourDrake.getAlleleString(), sexOfYourDrake);
      ++moveCount;
      render();
    }
  }), document.getElementById('drake-genome'));
}

function resetChallenge() {
  trialIndex = 1;
  moveCount = 0;
  resetDrakes();
}

function nextChallenge() {
  var url = window.location.href,
      nextUrl = undefined;
  if (challenge < 2) {
    // advance to next challenge
    nextUrl = url.replace('challenge=' + challenge, 'challenge=' + (challenge + 1));
  } else {
    // back to case log
    var case1Index = url.indexOf('case-1');
    nextUrl = url.substr(0, case1Index);
  }
  window.location.assign(nextUrl);
}

function advanceTrial() {
  if (challenge >= 2) {
    if (trialIndex >= trialCount) {
      showAlert(true, {
        title: "Congratulations!",
        message: "You've completed all the trials in this challenge.",
        okButton: "Go back to the Case Log",
        okCallback: nextChallenge,
        tryButton: "Try Again",
        tryCallback: resetChallenge
      });
      return;
    }
    ++trialIndex;
  }
  moveCount = 0;
  resetDrakes();
}

var alertClientButtonClickHandlers = {};
function showAlert(iShow, iOptions) {
  var displayMode = iShow ? 'block' : 'none',
      okButton = document.getElementById("alert-ok-button"),
      tryButton = document.getElementById("alert-try-button");
  if (iShow) {
    document.getElementById("alert-title").innerHTML = iOptions.title || "";
    document.getElementById("alert-message").innerHTML = iOptions.message || "";
    okButton.innerHTML = iOptions.okButton || "";
    okButton.style.display = iOptions.okButton ? 'block' : 'none';
    okButton.dataset.okCallback = iOptions.okCallback || '';
    alertClientButtonClickHandlers[okButton.id] = iOptions.okCallback || null;
    tryButton.innerHTML = iOptions.tryButton || "";
    tryButton.style.display = iOptions.tryButton ? 'block' : 'none';
    alertClientButtonClickHandlers[tryButton.id] = iOptions.tryCallback || null;
  } else {
    alertClientButtonClickHandlers[okButton.id] = null;
    alertClientButtonClickHandlers[tryButton.id] = null;
  }
  document.getElementById("overlay").style.display = displayMode;
  document.getElementById("alert-wrapper").style.display = displayMode;
}

document.getElementById("test-drake-button").onclick = function () {
  // Checking the answer counts as a move
  ++moveCount;
  showDrakeForConfirmation = true;
  render();

  if (0 === GeniBlocks.GeneticsUtils.numberOfChangesToReachPhenotype(yourDrake, targetDrake)) {
    if (challenge <= 1) {
      showAlert(true, {
        title: "Good work!",
        message: "The drake you have created matches the target drake.",
        okButton: "Next Challenge",
        okCallback: nextChallenge,
        tryButton: "Try Again",
        tryCallback: resetChallenge
      });
    } else {
      showAlert(true, {
        title: "Good work!",
        message: "The drake you have created matches the target drake.",
        okButton: "OK",
        okCallback: advanceTrial
      });
    }
  } else {
    showAlert(true, {
      title: "That's not the drake!",
      message: "The drake you have created doesn't match the target drake.\nPlease try again.",
      tryButton: "Try Again"
    });
    render();
  }
};

function alertButtonClickHandler(evt) {
  var clientClickHandler = alertClientButtonClickHandlers[evt.target.id];
  showAlert(false);
  showDrakeForConfirmation = false;
  if (clientClickHandler) clientClickHandler();
  render();
}

document.getElementById("alert-ok-button").onclick = alertButtonClickHandler;
document.getElementById("alert-try-button").onclick = alertButtonClickHandler;

resetDrakes();
//# sourceMappingURL=data:application/json;base64,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Vkw7R0FERixNQW9CSztBQUNILGNBQVUsSUFBVixFQUFnQjtBQUNFLGFBQU8sdUJBQVA7QUFDQSxlQUFTLCtFQUFUO0FBQ0EsaUJBQVcsV0FBWDtLQUhsQixFQURHO0FBTUgsYUFORztHQXBCTDtDQU5xRDs7QUFvQ3ZELFNBQVMsdUJBQVQsQ0FBaUMsR0FBakMsRUFBc0M7QUFDcEMsTUFBTSxxQkFBcUIsK0JBQStCLElBQUksTUFBSixDQUFXLEVBQVgsQ0FBcEQsQ0FEOEI7QUFFcEMsWUFBVSxLQUFWLEVBRm9DO0FBR3BDLDZCQUEyQixLQUEzQixDQUhvQztBQUlwQyxNQUFJLGtCQUFKLEVBQ0UscUJBREY7QUFFQSxXQU5vQztDQUF0Qzs7QUFTQSxTQUFTLGNBQVQsQ0FBd0IsaUJBQXhCLEVBQTJDLE9BQTNDLEdBQXFELHVCQUFyRDtBQUNBLFNBQVMsY0FBVCxDQUF3QixrQkFBeEIsRUFBNEMsT0FBNUMsR0FBc0QsdUJBQXREOztBQUVBIiwiZmlsZSI6ImNhc2UtMS9jaGFsbGVuZ2VzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDYXNlIDEgQ2hhbGxlbmdlc1xuICpcbiAqIFRoZSBjb2RlIGluIHRoaXMgbW9kdWxlIHdhcyB3cml0dGVuIHRvIHN1cHBvcnQgYSByZWNyZWF0aW9uIG9mIHRoZSBjaGFsbGVuZ2VzXG4gKiBmcm9tIENhc2UgMSBpbiBHZW5pdmVyc2UuIFRoZSBjaGFsbGVuZ2VzIGFyZTpcbiAqICBDaGFsbGVuZ2UgMDogTWF0Y2ggdGhlIHBoZW5vdHlwZSBvZiBhIHZpc2libGUgdGVzdCBkcmFrZSB0byB0aGF0IG9mIGEgdGFyZ2V0IGRyYWtlXG4gKiAgICAgICAgICAgICAgIChUaGlzIGNoYWxsZW5nZSBpcyBub3QgaW4gR2VuaXZlcnNlIGJ1dCBpdCB3YXMgZGVlbWVkIGEgdXNlZnVsIGFkZGl0aW9uLilcbiAqICBDaGFsbGVuZ2UgMTogTWF0Y2ggdGhlIHBoZW5vdHlwZSBvZiBhIGhpZGRlbiB0ZXN0IGRyYWtlIHRvIHRoYXQgb2YgYSB0YXJnZXQgZHJha2VcbiAqICBDaGFsbGVuZ2UgMjogTWF0Y2ggdGhlIHBoZW5vdHlwZSBvZiB0aHJlZSBoaWRkZW4gdGVzdCBkcmFrZXMgdG8gdGFyZ2V0IGRyYWtlc1xuICovXG5jb25zdCBjaGFsbGVuZ2VMYWJlbHMgPSBbJ2NoYWxsZW5nZS0wJywgJ2NoYWxsZW5nZS0xJywgJ2NoYWxsZW5nZS0yJ10sXG4gICAgICBjaGFsbGVuZ2VDb3VudCA9IGNoYWxsZW5nZUxhYmVscy5sZW5ndGgsXG4gICAgICBzZXhMYWJlbHMgPSBbJ21hbGUnLCAnZmVtYWxlJ10sXG4gICAgICBvcmdhbmlzbUFsbGVsZXMgPSBcImE6aCxiOmgsYTpDLGI6QyxhOmEsYjphLGE6QixiOkIsYTpELGI6RCxhOlQsYjp0LGE6cmgsYjpyaCxhOkJvZyxiOkJvZ1wiLFxuICAgICAgaGlkZGVuQWxsZWxlcyA9IFsndCcsJ3RrJywnaCcsJ2MnLCdhJywnYicsJ2QnLCdib2cnLCdyaCddO1xubGV0ICAgc2V4T2ZUYXJnZXREcmFrZSxcbiAgICAgIHRhcmdldERyYWtlLFxuICAgICAgc2V4T2ZZb3VyRHJha2UsXG4gICAgICB5b3VyRHJha2UsXG4gICAgICByZXF1aXJlZE1vdmVDb3VudCxcbiAgICAgIHNob3dEcmFrZUZvckNvbmZpcm1hdGlvbiA9IGZhbHNlLFxuICAgICAgdHJpYWxDb3VudCA9IDEsXG4gICAgICB0cmlhbEluZGV4ID0gMSxcbiAgICAgIG1vdmVDb3VudCA9IDA7XG5cbmZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcocXVlcnlTdHJpbmcpIHtcbiAgICBsZXQgcGFyYW1zID0ge30sIHF1ZXJpZXMsIHRtcCwgaSwgbDtcblxuICAgIC8vIFNwbGl0IGludG8ga2V5L3ZhbHVlIHBhaXJzXG4gICAgcXVlcmllcyA9IHF1ZXJ5U3RyaW5nLnNwbGl0KCcmJyk7XG5cbiAgICAvLyBDb252ZXJ0IHRoZSBhcnJheSBvZiBzdHJpbmdzIGludG8gYW4gb2JqZWN0XG4gICAgZm9yICggaSA9IDAsIGwgPSBxdWVyaWVzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHtcbiAgICAgICAgdG1wID0gcXVlcmllc1tpXS5zcGxpdCgnPScpO1xuICAgICAgICBwYXJhbXNbdG1wWzBdXSA9IHRtcFsxXTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGFyYW1zO1xufVxuXG5sZXQgdXJsUGFyYW1zID0gcGFyc2VRdWVyeVN0cmluZygod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuc3Vic3RyaW5nKDEpKSxcbiAgICBjaGFsbGVuZ2VQYXJhbSA9IHVybFBhcmFtcy5jaGFsbGVuZ2UgJiYgTnVtYmVyKHVybFBhcmFtcy5jaGFsbGVuZ2UpLFxuICAgIGNoYWxsZW5nZSA9IChjaGFsbGVuZ2VQYXJhbSA+PSAwKSAmJiAoY2hhbGxlbmdlUGFyYW0gPCBjaGFsbGVuZ2VDb3VudCkgPyBjaGFsbGVuZ2VQYXJhbSA6IDA7XG5cbmlmIChjaGFsbGVuZ2UgPj0gMilcbiAgdHJpYWxDb3VudCA9IDM7XG5cbmZ1bmN0aW9uIHJlc2V0RHJha2VzKCkge1xuICByZXF1aXJlZE1vdmVDb3VudCA9IDA7XG4gIC8vIHJlZ2VuZXJhdGUgaWYgd2UgZ2VuZXJhdGUgZHJha2VzIHRoYXQgYXJlIHRvbyBjbG9zZSB0byBlYWNoIG90aGVyXG4gIHdoaWxlIChyZXF1aXJlZE1vdmVDb3VudCA8IDMpIHtcbiAgICBzZXhPZlRhcmdldERyYWtlID0gTWF0aC5mbG9vcigyICogTWF0aC5yYW5kb20oKSk7XG4gICAgdGFyZ2V0RHJha2UgPSBuZXcgQmlvTG9naWNhLk9yZ2FuaXNtKEJpb0xvZ2ljYS5TcGVjaWVzLkRyYWtlLCBvcmdhbmlzbUFsbGVsZXMsIHNleE9mVGFyZ2V0RHJha2UpO1xuICAgIHNleE9mWW91ckRyYWtlID0gTWF0aC5mbG9vcigyICogTWF0aC5yYW5kb20oKSk7XG4gICAgeW91ckRyYWtlID0gbmV3IEJpb0xvZ2ljYS5PcmdhbmlzbShCaW9Mb2dpY2EuU3BlY2llcy5EcmFrZSwgb3JnYW5pc21BbGxlbGVzLCBzZXhPZllvdXJEcmFrZSk7XG4gICAgLy8gYWRkIG9uZSBmb3IgY2xpY2tpbmcgdGhlIFwiQ2hlY2sgRHJha2VcIiBidXR0b25cbiAgICByZXF1aXJlZE1vdmVDb3VudCA9IEdlbmlCbG9ja3MuR2VuZXRpY3NVdGlscy5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZDaGFuZ2VzVG9SZWFjaFBoZW5vdHlwZSh5b3VyRHJha2UsIHRhcmdldERyYWtlKSArIDE7XG4gIH1cbiAgcmVuZGVyKCk7XG59XG5cbmZ1bmN0aW9uIHJlbmRlcigpIHtcbiAgLy8gdGFyZ2V0IGRyYWtlXG4gIFJlYWN0RE9NLnJlbmRlcihcbiAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuT3JnYW5pc21HbG93Vmlldywge29yZzogdGFyZ2V0RHJha2UsIGNvbG9yOiAnI0ZGRkZBQScsIHNpemU6IDIwMH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YXJnZXQtZHJha2UnKSk7XG5cbiAgLy8gdHJpYWwgZmVlZGJhY2tcbiAgUmVhY3RET00ucmVuZGVyKFxuICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoR2VuaUJsb2Nrcy5GZWVkYmFja1ZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVFJJQUxcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHt0cmlhbEluZGV4fSBvZiAke3RyaWFsQ291bnR9YFxuICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHJpYWwtZmVlZGJhY2snKSk7XG5cbiAgLy8gZ29hbCBmZWVkYmFja1xuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLkZlZWRiYWNrVmlldywge1xuICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYEdPQUwgaXMgJHtyZXF1aXJlZE1vdmVDb3VudH0gTU9WRVNgLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBZb3VyIG1vdmVzOiAke21vdmVDb3VudH1gXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb2FsLWZlZWRiYWNrJykpO1xuXG4gIC8vIHlvdXIgZHJha2VcbiAgUmVhY3RET00ucmVuZGVyKFxuICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoR2VuaUJsb2Nrcy5RdWVzdGlvbk9yZ2FuaXNtR2xvd1ZpZXcsXG4gICAgICAgICAgICAgICAgICAgICAgICB7aGlkZGVuOiAoY2hhbGxlbmdlID4gMCkgJiYgIXNob3dEcmFrZUZvckNvbmZpcm1hdGlvbiwgXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG9yZzogeW91ckRyYWtlLCBjb2xvcjogJyNGRkZGQUEnLCBzaXplOiAyMDB9KSxcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneW91ci1kcmFrZScpKTtcbiAgLy8gUmVhY3RET00ucmVuZGVyKFxuICAvLyAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoR2VuaUJsb2Nrcy5IaWRhYmxlT3JnYW5pc21HbG93VmlldyxcbiAgLy8gICAgICAgICAgICAgICAgICAgICAgIHtoaWRkZW46IHRydWUsIG9yZzogeW91ckRyYWtlLCBjb2xvcjogJyNGRkZGQUEnLCBzaXplOiAyMDB9KSxcbiAgLy8gICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneW91ci1kcmFrZScpKTtcblxuICAvLyBjaGFuZ2Ugc2V4IGJ1dHRvbnNcbiAgUmVhY3RET00ucmVuZGVyKFxuICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoR2VuaUJsb2Nrcy5DaGFuZ2VTZXhCdXR0b25zLCB7XG4gICAgICAgICAgc2V4OiBzZXhMYWJlbHNbc2V4T2ZZb3VyRHJha2VdLFxuICAgICAgICAgIHNwZWNpZXM6IFwiRHJha2VcIixcbiAgICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oZXZ0LCBpU2V4KSB7XG4gICAgICAgICAgICAvLyByZXBsYWNlIGFsbGVsZXMgbG9zdCB3aGVuIHN3aXRjaGluZyB0byBtYWxlIGFuZCBiYWNrXG4gICAgICAgICAgICBjb25zdCBhbGxlbGVTdHJpbmcgPSBHZW5pQmxvY2tzLkdlbmV0aWNzVXRpbHMuZmlsbEluTWlzc2luZ0FsbGVsZXNGcm9tQWxsZWxlU3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlvdXJEcmFrZS5nZW5ldGljcywgeW91ckRyYWtlLmdldEFsbGVsZVN0cmluZygpLCBvcmdhbmlzbUFsbGVsZXMpO1xuICAgICAgICAgICAgc2V4T2ZZb3VyRHJha2UgPSBzZXhMYWJlbHMuaW5kZXhPZihpU2V4KTtcbiAgICAgICAgICAgIHlvdXJEcmFrZSA9IG5ldyBCaW9Mb2dpY2EuT3JnYW5pc20oQmlvTG9naWNhLlNwZWNpZXMuRHJha2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxlbGVTdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXhPZllvdXJEcmFrZSk7XG4gICAgICAgICAgICArK21vdmVDb3VudDtcbiAgICAgICAgICAgIHJlbmRlcigpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYW5nZS1zZXgtYnV0dG9ucycpXG4gICk7XG5cbiAgLy8gZ2Vub21lXG4gIFJlYWN0RE9NLnJlbmRlcihcbiAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuR2Vub21lVmlldywge1xuICAgICAgb3JnOiB5b3VyRHJha2UsXG4gICAgICBoaWRkZW5BbGxlbGVzOiBoaWRkZW5BbGxlbGVzLFxuICAgICAgc3R5bGU6IHttYXJnaW5Ub3A6IDUwLCB0b3A6IDUwfSxcbiAgICAgIGFsbGVsZUNoYW5nZWQ6IGZ1bmN0aW9uKGNocm9tLCBzaWRlLCBwcmV2QWxsZWxlLCBuZXdBbGxlbGUpIHtcbiAgICAgICAgeW91ckRyYWtlLmdlbmV0aWNzLmdlbm90eXBlLmNocm9tb3NvbWVzW2Nocm9tXVtzaWRlXS5hbGxlbGVzLnJlcGxhY2VGaXJzdChwcmV2QWxsZWxlLCBuZXdBbGxlbGUpO1xuICAgICAgICB5b3VyRHJha2UgPSBuZXcgQmlvTG9naWNhLk9yZ2FuaXNtKEJpb0xvZ2ljYS5TcGVjaWVzLkRyYWtlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3VyRHJha2UuZ2V0QWxsZWxlU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNleE9mWW91ckRyYWtlKTtcbiAgICAgICAgKyttb3ZlQ291bnQ7XG4gICAgICAgIHJlbmRlcigpO1xuICAgICAgfVxuICAgIH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmFrZS1nZW5vbWUnKVxuICApO1xuXG59XG5cbmZ1bmN0aW9uIHJlc2V0Q2hhbGxlbmdlKCkge1xuICB0cmlhbEluZGV4ID0gMTtcbiAgbW92ZUNvdW50ID0gMDtcbiAgcmVzZXREcmFrZXMoKTtcbn1cblxuZnVuY3Rpb24gbmV4dENoYWxsZW5nZSgpIHtcbiAgbGV0IHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLFxuICAgICAgbmV4dFVybDtcbiAgaWYgKGNoYWxsZW5nZSA8IDIpIHtcbiAgICAvLyBhZHZhbmNlIHRvIG5leHQgY2hhbGxlbmdlXG4gICAgbmV4dFVybCA9IHVybC5yZXBsYWNlKGBjaGFsbGVuZ2U9JHtjaGFsbGVuZ2V9YCwgYGNoYWxsZW5nZT0ke2NoYWxsZW5nZSsxfWApO1xuICB9XG4gIGVsc2Uge1xuICAgIC8vIGJhY2sgdG8gY2FzZSBsb2dcbiAgICBjb25zdCBjYXNlMUluZGV4ID0gdXJsLmluZGV4T2YoJ2Nhc2UtMScpO1xuICAgIG5leHRVcmwgPSB1cmwuc3Vic3RyKDAsIGNhc2UxSW5kZXgpO1xuICB9XG4gIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24obmV4dFVybCk7XG59XG5cbmZ1bmN0aW9uIGFkdmFuY2VUcmlhbCgpIHtcbiAgaWYgKGNoYWxsZW5nZSA+PSAyKSB7XG4gICAgaWYgKHRyaWFsSW5kZXggPj0gdHJpYWxDb3VudCkge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIkNvbmdyYXR1bGF0aW9ucyFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiWW91J3ZlIGNvbXBsZXRlZCBhbGwgdGhlIHRyaWFscyBpbiB0aGlzIGNoYWxsZW5nZS5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uOiBcIkdvIGJhY2sgdG8gdGhlIENhc2UgTG9nXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0NhbGxiYWNrOiBuZXh0Q2hhbGxlbmdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5QnV0dG9uOiBcIlRyeSBBZ2FpblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q2FsbGJhY2s6IHJlc2V0Q2hhbGxlbmdlXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgICsrdHJpYWxJbmRleDtcbiAgfVxuICBtb3ZlQ291bnQgPSAwO1xuICByZXNldERyYWtlcygpO1xufVxuXG5sZXQgYWxlcnRDbGllbnRCdXR0b25DbGlja0hhbmRsZXJzID0ge307XG5mdW5jdGlvbiBzaG93QWxlcnQoaVNob3csIGlPcHRpb25zKSB7XG4gIGNvbnN0IGRpc3BsYXlNb2RlID0gaVNob3cgPyAnYmxvY2snIDogJ25vbmUnLFxuICAgICAgICBva0J1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtb2stYnV0dG9uXCIpLFxuICAgICAgICB0cnlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LXRyeS1idXR0b25cIik7XG4gIGlmIChpU2hvdykge1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtdGl0bGVcIikuaW5uZXJIVE1MID0gaU9wdGlvbnMudGl0bGUgfHwgXCJcIjtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LW1lc3NhZ2VcIikuaW5uZXJIVE1MID0gaU9wdGlvbnMubWVzc2FnZSB8fCBcIlwiO1xuICAgIG9rQnV0dG9uLmlubmVySFRNTCA9IGlPcHRpb25zLm9rQnV0dG9uIHx8IFwiXCI7XG4gICAgb2tCdXR0b24uc3R5bGUuZGlzcGxheSA9IGlPcHRpb25zLm9rQnV0dG9uID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgICBva0J1dHRvbi5kYXRhc2V0Lm9rQ2FsbGJhY2sgPSBpT3B0aW9ucy5va0NhbGxiYWNrIHx8ICcnO1xuICAgIGFsZXJ0Q2xpZW50QnV0dG9uQ2xpY2tIYW5kbGVyc1tva0J1dHRvbi5pZF0gPSBpT3B0aW9ucy5va0NhbGxiYWNrIHx8IG51bGw7XG4gICAgdHJ5QnV0dG9uLmlubmVySFRNTCA9IGlPcHRpb25zLnRyeUJ1dHRvbiB8fCBcIlwiO1xuICAgIHRyeUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gaU9wdGlvbnMudHJ5QnV0dG9uID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgICBhbGVydENsaWVudEJ1dHRvbkNsaWNrSGFuZGxlcnNbdHJ5QnV0dG9uLmlkXSA9IGlPcHRpb25zLnRyeUNhbGxiYWNrIHx8IG51bGw7XG4gIH1cbiAgZWxzZSB7XG4gICAgYWxlcnRDbGllbnRCdXR0b25DbGlja0hhbmRsZXJzW29rQnV0dG9uLmlkXSA9IG51bGw7XG4gICAgYWxlcnRDbGllbnRCdXR0b25DbGlja0hhbmRsZXJzW3RyeUJ1dHRvbi5pZF0gPSBudWxsO1xuICB9XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwib3ZlcmxheVwiKS5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheU1vZGU7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtd3JhcHBlclwiKS5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheU1vZGU7XG59XG5cbmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdC1kcmFrZS1idXR0b25cIikub25jbGljayA9IGZ1bmN0aW9uKCkge1xuICAvLyBDaGVja2luZyB0aGUgYW5zd2VyIGNvdW50cyBhcyBhIG1vdmVcbiAgKyttb3ZlQ291bnQ7XG4gIHNob3dEcmFrZUZvckNvbmZpcm1hdGlvbiA9IHRydWU7XG4gIHJlbmRlcigpO1xuXG4gIGlmICgwID09PSBHZW5pQmxvY2tzLkdlbmV0aWNzVXRpbHMubnVtYmVyT2ZDaGFuZ2VzVG9SZWFjaFBoZW5vdHlwZSh5b3VyRHJha2UsIHRhcmdldERyYWtlKSkge1xuICAgIGlmIChjaGFsbGVuZ2UgPD0gMSkge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJHb29kIHdvcmshXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlRoZSBkcmFrZSB5b3UgaGF2ZSBjcmVhdGVkIG1hdGNoZXMgdGhlIHRhcmdldCBkcmFrZS5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uOiBcIk5leHQgQ2hhbGxlbmdlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0NhbGxiYWNrOiBuZXh0Q2hhbGxlbmdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5QnV0dG9uOiBcIlRyeSBBZ2FpblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q2FsbGJhY2s6IHJlc2V0Q2hhbGxlbmdlXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJHb29kIHdvcmshXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlRoZSBkcmFrZSB5b3UgaGF2ZSBjcmVhdGVkIG1hdGNoZXMgdGhlIHRhcmdldCBkcmFrZS5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uOiBcIk9LXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0NhbGxiYWNrOiBhZHZhbmNlVHJpYWxcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgc2hvd0FsZXJ0KHRydWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJUaGF0J3Mgbm90IHRoZSBkcmFrZSFcIixcbiAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIlRoZSBkcmFrZSB5b3UgaGF2ZSBjcmVhdGVkIGRvZXNuJ3QgbWF0Y2ggdGhlIHRhcmdldCBkcmFrZS5cXG5QbGVhc2UgdHJ5IGFnYWluLlwiLFxuICAgICAgICAgICAgICAgICAgICAgIHRyeUJ1dHRvbjogXCJUcnkgQWdhaW5cIlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICByZW5kZXIoKTtcbiAgfVxufTtcblxuZnVuY3Rpb24gYWxlcnRCdXR0b25DbGlja0hhbmRsZXIoZXZ0KSB7XG4gIGNvbnN0IGNsaWVudENsaWNrSGFuZGxlciA9IGFsZXJ0Q2xpZW50QnV0dG9uQ2xpY2tIYW5kbGVyc1tldnQudGFyZ2V0LmlkXTtcbiAgc2hvd0FsZXJ0KGZhbHNlKTtcbiAgc2hvd0RyYWtlRm9yQ29uZmlybWF0aW9uID0gZmFsc2U7XG4gIGlmIChjbGllbnRDbGlja0hhbmRsZXIpXG4gICAgY2xpZW50Q2xpY2tIYW5kbGVyKCk7XG4gIHJlbmRlcigpO1xufVxuXG5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LW9rLWJ1dHRvblwiKS5vbmNsaWNrID0gYWxlcnRCdXR0b25DbGlja0hhbmRsZXI7XG5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LXRyeS1idXR0b25cIikub25jbGljayA9IGFsZXJ0QnV0dG9uQ2xpY2tIYW5kbGVyO1xuXG5yZXNldERyYWtlcygpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
