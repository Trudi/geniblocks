'use strict';

var challengeLabels = ['challenge-0', 'challenge-1', 'challenge-2'],
    challengeCount = challengeLabels.length,
    sexLabels = ['male', 'female'],
    organismAlleles = "a:h,b:h,a:C,b:C,a:a,b:a,a:B,b:B,a:D,b:D,a:T,b:t,a:rh,b:rh,a:Bog,b:Bog",
    hiddenAlleles = ['t', 'tk', 'h', 'c', 'a', 'b', 'd', 'bog', 'rh'];
var _possibleAllelesForTrait = {},
    sexOfTargetDrake = undefined,
    targetDrake = undefined,
    sexOfYourDrake = undefined,
    yourDrake = undefined,
    requiredMoveCount = undefined,
    showDrakeForConfirmation = false,
    trialCount = 1,
    trialIndex = 1,
    moveCount = 0;

function parseQueryString(queryString) {
  var params = {},
      queries = undefined,
      temp = undefined,
      i = undefined,
      l = undefined;

  // Split into key/value pairs
  queries = queryString.split('&');

  // Convert the array of strings into an object
  for (i = 0, l = queries.length; i < l; i++) {
    temp = queries[i].split('=');
    params[temp[0]] = temp[1];
  }

  return params;
}

var urlParams = parseQueryString(window.location.search.substring(1)),
    challengeParam = urlParams.challenge && Number(urlParams.challenge),
    challenge = challengeParam >= 0 && challengeParam < challengeCount ? challengeParam : 0;

if (challenge >= 2) trialCount = 3;

function resetDrakes() {
  requiredMoveCount = 0;
  // regenerate if we generate two identical drakes
  while (requiredMoveCount === 0) {
    sexOfTargetDrake = Math.floor(2 * Math.random());
    targetDrake = new BioLogica.Organism(BioLogica.Species.Drake, organismAlleles, sexOfTargetDrake);
    sexOfYourDrake = Math.floor(2 * Math.random());
    yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, organismAlleles, sexOfYourDrake);
    requiredMoveCount = numberOfMovesToReachPhenotype(yourDrake, targetDrake);
  }
  render();
}

function render() {
  // target drake
  ReactDOM.render(React.createElement(GeniBlocks.OrganismGlowView, { org: targetDrake, color: '#FFFFAA', size: 200 }), document.getElementById('target-drake'));

  // trial feedback
  ReactDOM.render(React.createElement(GeniBlocks.FeedbackView, {
    text: ["TRIAL", trialIndex + ' of ' + trialCount]
  }), document.getElementById('trial-feedback'));

  // goal feedback
  ReactDOM.render(React.createElement(GeniBlocks.FeedbackView, {
    text: ['GOAL is ' + requiredMoveCount + ' MOVES', 'Your moves: ' + moveCount]
  }), document.getElementById('goal-feedback'));

  // your drake
  ReactDOM.render(React.createElement(GeniBlocks.QuestionOrganismGlowView, { hidden: challenge > 0 && !showDrakeForConfirmation,
    org: yourDrake, color: '#FFFFAA', size: 200 }), document.getElementById('your-drake'));
  // ReactDOM.render(
  //   React.createElement(GeniBlocks.HidableOrganismGlowView,
  //                       {hidden: true, org: yourDrake, color: '#FFFFAA', size: 200}),
  //   document.getElementById('your-drake'));

  // change sex buttons
  ReactDOM.render(React.createElement(GeniBlocks.ChangeSexButtons, {
    sex: sexLabels[sexOfYourDrake],
    species: "Drake",
    onChange: function onChange(evt, iSex) {
      sexOfYourDrake = sexLabels.indexOf(iSex);
      yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, yourDrake.getAlleleString(), sexOfYourDrake);
      ++moveCount;
      render();
    }
  }), document.getElementById('change-sex-buttons'));

  // genome
  ReactDOM.render(React.createElement(GeniBlocks.GenomeView, {
    org: yourDrake,
    hiddenAlleles: hiddenAlleles,
    style: { marginTop: 50, top: 50 },
    alleleChanged: function alleleChanged(chrom, side, prevAllele, newAllele) {
      yourDrake.genetics.genotype.chromosomes[chrom][side].alleles.replaceFirst(prevAllele, newAllele);
      yourDrake = new BioLogica.Organism(BioLogica.Species.Drake, yourDrake.getAlleleString(), sexOfYourDrake);
      ++moveCount;
      render();
    }
  }), document.getElementById('drake-genome'));
}

function numberOfMovesToReachPhenotype(testDrake, targetDrake) {
  var requiredMoveCount = numberOfAlleleChangesToReachPhenotype(testDrake.phenotype.characteristics, targetDrake.phenotype.characteristics, testDrake.genetics.genotype.allAlleles, testDrake.species.traitRules);
  if (testDrake.sex !== targetDrake.sex) ++requiredMoveCount;

  return requiredMoveCount;
}

function numberOfAlleleChangesToReachPhenotype(testCharacteristics, targetCharacteristics, testAlleles, traitRules) {
  var alleles = testAlleles,
      moves = 0;

  for (var trait in traitRules) {
    if (traitRules.hasOwnProperty(trait)) {
      if (testCharacteristics[trait] !== targetCharacteristics[trait]) {
        // first we have to work out what alleles the original drake has that correspond to
        // their non-matching trait
        var possibleTraitAlleles = collectAllAllelesForTrait(trait, traitRules),
            characteristicAlleles = [];
        for (var i = 0, ii = alleles.length; i < ii; i++) {
          if (possibleTraitAlleles.indexOf(alleles[i]) >= 0) {
            characteristicAlleles.push(alleles[i]);
          }
        }
        // now work out the smallest number of steps to get from there to the desired characteristic
        var possibleSolutions = traitRules[trait][targetCharacteristics[trait]],
            shortestPathLength = Infinity;
        for (i = 0, ii = possibleSolutions.length; i < ii; i++) {
          var solution = possibleSolutions[i].slice(),
              pathLength = 0;
          for (var j = 0, jj = characteristicAlleles.length; j < jj; j++) {
            if (solution.indexOf(characteristicAlleles[j]) === -1) {
              pathLength++;
            } else {
              solution.splice(solution.indexOf(characteristicAlleles[j]), 1); // already matched this one, can't match it again
            }
          }
          shortestPathLength = pathLength < shortestPathLength ? pathLength : shortestPathLength;
        }
        moves += shortestPathLength;
      }
    }
  }
  return moves;
}

// Goes through the traitRules to find out what unique alleles are associated with each trait
// E.g. For "tail" it will return ["T", "Tk", "t"]
function collectAllAllelesForTrait(trait, traitRules) {
  if (_possibleAllelesForTrait[trait]) {
    return _possibleAllelesForTrait[trait];
  }

  var allelesHash = {},
      alleles = [];
  for (var characteristic in traitRules[trait]) {
    for (var possibileAllelesCombo in traitRules[trait][characteristic]) {
      if (traitRules[trait][characteristic].hasOwnProperty(possibileAllelesCombo)) {
        for (var i = 0, ii = traitRules[trait][characteristic][possibileAllelesCombo].length; i < ii; i++) {
          allelesHash[traitRules[trait][characteristic][possibileAllelesCombo][i]] = 1;
        }
      }
    }
  }

  for (var allele in allelesHash) {
    alleles.push(allele);
  }

  _possibleAllelesForTrait[trait] = alleles; // store so we don't need to recalculate it
  return alleles;
}

function checkDrake(iYourDrake, iTargetDrake, iHiddenGenes) {
  var characteristicToGeneMap = {
    "armor": "armor",
    "tail": "tail",
    "forelimbs": "forelimbs",
    "hindlimbs": "hindlimbs",
    "horns": "horns",
    "nose spike": "nose",
    "wings": "wings",
    "color": "color",
    "health": "bogbreath",
    "liveliness": "dilute"
  };
  if (iYourDrake.sex !== iTargetDrake.sex) return false;
  for (var ch in iYourDrake.phenotype.characteristics) {
    var yourValue = iYourDrake.phenotype.characteristics[ch],
        targetValue = iTargetDrake.phenotype.characteristics[ch],
        gene = characteristicToGeneMap[ch];
    if (!iHiddenGenes.has(gene) && yourValue !== targetValue) return false;
  }
  return true;
}

/*eslint no-unused-vars: [1, { "varsIgnorePattern": "resetChallenge|nextChallenge|advanceTrial" }]*/
var resetChallenge = function resetChallenge() {
  trialIndex = 1;
  moveCount = 0;
  resetDrakes();
};

var nextChallenge = function nextChallenge() {
  var url = window.location.href,
      nextUrl = undefined;
  if (challenge < 2) {
    nextUrl = url.replace('challenge=' + challenge, 'challenge=' + (challenge + 1));
  } else {
    var case1Index = url.indexOf('case-1');
    nextUrl = url.substr(0, case1Index);
  }
  window.location.assign(nextUrl);
};

var advanceTrial = function advanceTrial() {
  if (challenge >= 2) {
    if (trialIndex >= trialCount) {
      showAlert(true, {
        title: "Congratulations!",
        message1: "You've completed all the trials in this challenge.",
        okButton: "Go back to the Case Log",
        okCallback: "nextChallenge",
        tryButton: "Try Again",
        tryCallback: "resetChallenge"
      });
      return;
    }
    ++trialIndex;
  }
  moveCount = 0;
  resetDrakes();
};

function showAlert(iShow, iOptions) {
  var displayMode = iShow ? 'block' : 'none';
  if (iShow) {
    document.getElementById("alert-title").innerHTML = iOptions.title || "";
    document.getElementById("alert-message1").innerHTML = iOptions.message1 || "";
    document.getElementById("alert-message2").innerHTML = iOptions.message2 || "";
    document.getElementById("alert-ok-button").innerHTML = iOptions.okButton || "";
    document.getElementById("alert-ok-button").style.display = iOptions.okButton ? 'block' : 'none';
    document.getElementById("alert-ok-button").dataset.okCallback = iOptions.okCallback || '';
    document.getElementById("alert-try-button").innerHTML = iOptions.tryButton || "";
    document.getElementById("alert-try-button").style.display = iOptions.tryButton ? 'block' : 'none';
    document.getElementById("alert-try-button").dataset.tryCallback = iOptions.tryCallback || '';
  }
  document.getElementById("overlay").style.display = displayMode;
  document.getElementById("alert-wrapper").style.display = displayMode;
}

document.getElementById("test-drake-button").onclick = function () {
  showDrakeForConfirmation = true;
  render();

  if (numberOfMovesToReachPhenotype(yourDrake, targetDrake) === 0) {
    if (challenge <= 1) {
      showAlert(true, {
        title: "Good work!",
        message1: "The drake you have created matches the target drake.",
        okButton: "Next Challenge",
        okCallback: "nextChallenge",
        tryButton: "Try Again",
        tryCallback: "resetChallenge"
      });
    } else {
      showAlert(true, {
        title: "Good work!",
        message1: "The drake you have created matches the target drake.",
        okButton: "OK",
        okCallback: "advanceTrial"
      });
    }
  } else {
    showAlert(true, {
      title: "That's not the drake!",
      message1: "The drake you have created doesn't match the target drake.\nPlease try again.",
      tryButton: "Try Again"
    });
    render();
  }
};

document.getElementById("alert-ok-button").onclick = function (evt) {
  showAlert(false);
  showDrakeForConfirmation = false;
  if (evt.target.dataset.okCallback && window[evt.target.dataset.okCallback]) window[evt.target.dataset.okCallback].call();
  render();
};

document.getElementById("alert-try-button").onclick = function (evt) {
  showAlert(false);
  showDrakeForConfirmation = false;
  if (evt.target.dataset.tryCallback && window[evt.target.dataset.tryCallback]) window[evt.target.dataset.tryCallback].call();
  render();
};

resetDrakes();
//# sourceMappingURL=data:application/json;base64,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QU1ILGFBTkc7R0FwQkw7Q0FKcUQ7O0FBa0N2RCxTQUFTLGNBQVQsQ0FBd0IsaUJBQXhCLEVBQTJDLE9BQTNDLEdBQXFELFVBQVMsR0FBVCxFQUFjO0FBQ2pFLFlBQVUsS0FBVixFQURpRTtBQUVqRSw2QkFBMkIsS0FBM0IsQ0FGaUU7QUFHakUsTUFBSSxJQUFJLE1BQUosQ0FBVyxPQUFYLENBQW1CLFVBQW5CLElBQWlDLE9BQU8sSUFBSSxNQUFKLENBQVcsT0FBWCxDQUFtQixVQUFuQixDQUF4QyxFQUNGLE9BQU8sSUFBSSxNQUFKLENBQVcsT0FBWCxDQUFtQixVQUFuQixDQUFQLENBQXNDLElBQXRDLEdBREY7QUFFQSxXQUxpRTtDQUFkOztBQVFyRCxTQUFTLGNBQVQsQ0FBd0Isa0JBQXhCLEVBQTRDLE9BQTVDLEdBQXNELFVBQVMsR0FBVCxFQUFjO0FBQ2xFLFlBQVUsS0FBVixFQURrRTtBQUVsRSw2QkFBMkIsS0FBM0IsQ0FGa0U7QUFHbEUsTUFBSSxJQUFJLE1BQUosQ0FBVyxPQUFYLENBQW1CLFdBQW5CLElBQWtDLE9BQU8sSUFBSSxNQUFKLENBQVcsT0FBWCxDQUFtQixXQUFuQixDQUF6QyxFQUNGLE9BQU8sSUFBSSxNQUFKLENBQVcsT0FBWCxDQUFtQixXQUFuQixDQUFQLENBQXVDLElBQXZDLEdBREY7QUFFQSxXQUxrRTtDQUFkOztBQVF0RCIsImZpbGUiOiJjYXNlLTEvY2hhbGxlbmdlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNoYWxsZW5nZUxhYmVscyA9IFsnY2hhbGxlbmdlLTAnLCAnY2hhbGxlbmdlLTEnLCAnY2hhbGxlbmdlLTInXSxcbiAgICAgIGNoYWxsZW5nZUNvdW50ID0gY2hhbGxlbmdlTGFiZWxzLmxlbmd0aCxcbiAgICAgIHNleExhYmVscyA9IFsnbWFsZScsICdmZW1hbGUnXSxcbiAgICAgIG9yZ2FuaXNtQWxsZWxlcyA9IFwiYTpoLGI6aCxhOkMsYjpDLGE6YSxiOmEsYTpCLGI6QixhOkQsYjpELGE6VCxiOnQsYTpyaCxiOnJoLGE6Qm9nLGI6Qm9nXCIsXG4gICAgICBoaWRkZW5BbGxlbGVzID0gWyd0JywndGsnLCdoJywnYycsJ2EnLCdiJywnZCcsJ2JvZycsJ3JoJ107XG5sZXQgICBfcG9zc2libGVBbGxlbGVzRm9yVHJhaXQgPSB7fSxcbiAgICAgIHNleE9mVGFyZ2V0RHJha2UsXG4gICAgICB0YXJnZXREcmFrZSxcbiAgICAgIHNleE9mWW91ckRyYWtlLFxuICAgICAgeW91ckRyYWtlLFxuICAgICAgcmVxdWlyZWRNb3ZlQ291bnQsXG4gICAgICBzaG93RHJha2VGb3JDb25maXJtYXRpb24gPSBmYWxzZSxcbiAgICAgIHRyaWFsQ291bnQgPSAxLFxuICAgICAgdHJpYWxJbmRleCA9IDEsXG4gICAgICBtb3ZlQ291bnQgPSAwO1xuXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5U3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9LCBxdWVyaWVzLCB0ZW1wLCBpLCBsO1xuXG4gICAgLy8gU3BsaXQgaW50byBrZXkvdmFsdWUgcGFpcnNcbiAgICBxdWVyaWVzID0gcXVlcnlTdHJpbmcuc3BsaXQoJyYnKTtcblxuICAgIC8vIENvbnZlcnQgdGhlIGFycmF5IG9mIHN0cmluZ3MgaW50byBhbiBvYmplY3RcbiAgICBmb3IgKCBpID0gMCwgbCA9IHF1ZXJpZXMubGVuZ3RoOyBpIDwgbDsgaSsrICkge1xuICAgICAgICB0ZW1wID0gcXVlcmllc1tpXS5zcGxpdCgnPScpO1xuICAgICAgICBwYXJhbXNbdGVtcFswXV0gPSB0ZW1wWzFdO1xuICAgIH1cblxuICAgIHJldHVybiBwYXJhbXM7XG59XG5cbmxldCB1cmxQYXJhbXMgPSBwYXJzZVF1ZXJ5U3RyaW5nKCh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5zdWJzdHJpbmcoMSkpLFxuICAgIGNoYWxsZW5nZVBhcmFtID0gdXJsUGFyYW1zLmNoYWxsZW5nZSAmJiBOdW1iZXIodXJsUGFyYW1zLmNoYWxsZW5nZSksXG4gICAgY2hhbGxlbmdlID0gKGNoYWxsZW5nZVBhcmFtID49IDApICYmIChjaGFsbGVuZ2VQYXJhbSA8IGNoYWxsZW5nZUNvdW50KSA/IGNoYWxsZW5nZVBhcmFtIDogMDtcblxuaWYgKGNoYWxsZW5nZSA+PSAyKVxuICB0cmlhbENvdW50ID0gMztcblxuZnVuY3Rpb24gcmVzZXREcmFrZXMoKSB7XG4gIHJlcXVpcmVkTW92ZUNvdW50ID0gMDtcbiAgLy8gcmVnZW5lcmF0ZSBpZiB3ZSBnZW5lcmF0ZSB0d28gaWRlbnRpY2FsIGRyYWtlc1xuICB3aGlsZSAocmVxdWlyZWRNb3ZlQ291bnQgPT09IDApIHtcbiAgICBzZXhPZlRhcmdldERyYWtlID0gTWF0aC5mbG9vcigyICogTWF0aC5yYW5kb20oKSk7XG4gICAgdGFyZ2V0RHJha2UgPSBuZXcgQmlvTG9naWNhLk9yZ2FuaXNtKEJpb0xvZ2ljYS5TcGVjaWVzLkRyYWtlLCBvcmdhbmlzbUFsbGVsZXMsIHNleE9mVGFyZ2V0RHJha2UpO1xuICAgIHNleE9mWW91ckRyYWtlID0gTWF0aC5mbG9vcigyICogTWF0aC5yYW5kb20oKSk7XG4gICAgeW91ckRyYWtlID0gbmV3IEJpb0xvZ2ljYS5PcmdhbmlzbShCaW9Mb2dpY2EuU3BlY2llcy5EcmFrZSwgb3JnYW5pc21BbGxlbGVzLCBzZXhPZllvdXJEcmFrZSk7XG4gICAgcmVxdWlyZWRNb3ZlQ291bnQgPSBudW1iZXJPZk1vdmVzVG9SZWFjaFBoZW5vdHlwZSh5b3VyRHJha2UsIHRhcmdldERyYWtlKTtcbiAgfVxuICByZW5kZXIoKTtcbn1cblxuZnVuY3Rpb24gcmVuZGVyKCkge1xuICAvLyB0YXJnZXQgZHJha2VcbiAgUmVhY3RET00ucmVuZGVyKFxuICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoR2VuaUJsb2Nrcy5PcmdhbmlzbUdsb3dWaWV3LCB7b3JnOiB0YXJnZXREcmFrZSwgY29sb3I6ICcjRkZGRkFBJywgc2l6ZTogMjAwfSksXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhcmdldC1kcmFrZScpKTtcblxuICAvLyB0cmlhbCBmZWVkYmFja1xuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLkZlZWRiYWNrVmlldywge1xuICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJUUklBTFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3RyaWFsSW5kZXh9IG9mICR7dHJpYWxDb3VudH1gXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0cmlhbC1mZWVkYmFjaycpKTtcblxuICAvLyBnb2FsIGZlZWRiYWNrXG4gIFJlYWN0RE9NLnJlbmRlcihcbiAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEdlbmlCbG9ja3MuRmVlZGJhY2tWaWV3LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgR09BTCBpcyAke3JlcXVpcmVkTW92ZUNvdW50fSBNT1ZFU2AsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYFlvdXIgbW92ZXM6ICR7bW92ZUNvdW50fWBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvYWwtZmVlZGJhY2snKSk7XG5cbiAgLy8geW91ciBkcmFrZVxuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLlF1ZXN0aW9uT3JnYW5pc21HbG93VmlldyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtoaWRkZW46IChjaGFsbGVuZ2UgPiAwKSAmJiAhc2hvd0RyYWtlRm9yQ29uZmlybWF0aW9uLCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgb3JnOiB5b3VyRHJha2UsIGNvbG9yOiAnI0ZGRkZBQScsIHNpemU6IDIwMH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd5b3VyLWRyYWtlJykpO1xuICAvLyBSZWFjdERPTS5yZW5kZXIoXG4gIC8vICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLkhpZGFibGVPcmdhbmlzbUdsb3dWaWV3LFxuICAvLyAgICAgICAgICAgICAgICAgICAgICAge2hpZGRlbjogdHJ1ZSwgb3JnOiB5b3VyRHJha2UsIGNvbG9yOiAnI0ZGRkZBQScsIHNpemU6IDIwMH0pLFxuICAvLyAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd5b3VyLWRyYWtlJykpO1xuXG4gIC8vIGNoYW5nZSBzZXggYnV0dG9uc1xuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLkNoYW5nZVNleEJ1dHRvbnMsIHtcbiAgICAgICAgICBzZXg6IHNleExhYmVsc1tzZXhPZllvdXJEcmFrZV0sXG4gICAgICAgICAgc3BlY2llczogXCJEcmFrZVwiLFxuICAgICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbihldnQsIGlTZXgpIHtcbiAgICAgICAgICAgIHNleE9mWW91ckRyYWtlID0gc2V4TGFiZWxzLmluZGV4T2YoaVNleCk7XG4gICAgICAgICAgICB5b3VyRHJha2UgPSBuZXcgQmlvTG9naWNhLk9yZ2FuaXNtKEJpb0xvZ2ljYS5TcGVjaWVzLkRyYWtlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91ckRyYWtlLmdldEFsbGVsZVN0cmluZygpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V4T2ZZb3VyRHJha2UpO1xuICAgICAgICAgICAgKyttb3ZlQ291bnQ7XG4gICAgICAgICAgICByZW5kZXIoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFuZ2Utc2V4LWJ1dHRvbnMnKVxuICApO1xuXG4gIC8vIGdlbm9tZVxuICBSZWFjdERPTS5yZW5kZXIoXG4gICAgUmVhY3QuY3JlYXRlRWxlbWVudChHZW5pQmxvY2tzLkdlbm9tZVZpZXcsIHtcbiAgICAgIG9yZzogeW91ckRyYWtlLFxuICAgICAgaGlkZGVuQWxsZWxlczogaGlkZGVuQWxsZWxlcyxcbiAgICAgIHN0eWxlOiB7bWFyZ2luVG9wOiA1MCwgdG9wOiA1MH0sXG4gICAgICBhbGxlbGVDaGFuZ2VkOiBmdW5jdGlvbihjaHJvbSwgc2lkZSwgcHJldkFsbGVsZSwgbmV3QWxsZWxlKSB7XG4gICAgICAgIHlvdXJEcmFrZS5nZW5ldGljcy5nZW5vdHlwZS5jaHJvbW9zb21lc1tjaHJvbV1bc2lkZV0uYWxsZWxlcy5yZXBsYWNlRmlyc3QocHJldkFsbGVsZSwgbmV3QWxsZWxlKTtcbiAgICAgICAgeW91ckRyYWtlID0gbmV3IEJpb0xvZ2ljYS5PcmdhbmlzbShCaW9Mb2dpY2EuU3BlY2llcy5EcmFrZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91ckRyYWtlLmdldEFsbGVsZVN0cmluZygpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXhPZllvdXJEcmFrZSk7XG4gICAgICAgICsrbW92ZUNvdW50O1xuICAgICAgICByZW5kZXIoKTtcbiAgICAgIH1cbiAgICB9KSxcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZHJha2UtZ2Vub21lJylcbiAgKTtcblxufVxuXG5mdW5jdGlvbiBudW1iZXJPZk1vdmVzVG9SZWFjaFBoZW5vdHlwZSh0ZXN0RHJha2UsIHRhcmdldERyYWtlKSB7XG4gIGxldCByZXF1aXJlZE1vdmVDb3VudCA9IG51bWJlck9mQWxsZWxlQ2hhbmdlc1RvUmVhY2hQaGVub3R5cGUodGVzdERyYWtlLnBoZW5vdHlwZS5jaGFyYWN0ZXJpc3RpY3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RHJha2UucGhlbm90eXBlLmNoYXJhY3RlcmlzdGljcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0RHJha2UuZ2VuZXRpY3MuZ2Vub3R5cGUuYWxsQWxsZWxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0RHJha2Uuc3BlY2llcy50cmFpdFJ1bGVzKTtcbiAgaWYgKHRlc3REcmFrZS5zZXggIT09IHRhcmdldERyYWtlLnNleClcbiAgICArK3JlcXVpcmVkTW92ZUNvdW50O1xuXG4gIHJldHVybiByZXF1aXJlZE1vdmVDb3VudDtcbn1cblxuZnVuY3Rpb24gbnVtYmVyT2ZBbGxlbGVDaGFuZ2VzVG9SZWFjaFBoZW5vdHlwZSh0ZXN0Q2hhcmFjdGVyaXN0aWNzLCB0YXJnZXRDaGFyYWN0ZXJpc3RpY3MsIHRlc3RBbGxlbGVzLCB0cmFpdFJ1bGVzKXtcbiAgdmFyIGFsbGVsZXMgPSB0ZXN0QWxsZWxlcyxcbiAgICAgIG1vdmVzICAgPSAwO1xuXG4gIGZvciAodmFyIHRyYWl0IGluIHRyYWl0UnVsZXMpIHtcbiAgICBpZiAodHJhaXRSdWxlcy5oYXNPd25Qcm9wZXJ0eSh0cmFpdCkpIHtcbiAgICAgIGlmICh0ZXN0Q2hhcmFjdGVyaXN0aWNzW3RyYWl0XSAhPT0gdGFyZ2V0Q2hhcmFjdGVyaXN0aWNzW3RyYWl0XSkge1xuICAgICAgICAvLyBmaXJzdCB3ZSBoYXZlIHRvIHdvcmsgb3V0IHdoYXQgYWxsZWxlcyB0aGUgb3JpZ2luYWwgZHJha2UgaGFzIHRoYXQgY29ycmVzcG9uZCB0b1xuICAgICAgICAvLyB0aGVpciBub24tbWF0Y2hpbmcgdHJhaXRcbiAgICAgICAgdmFyIHBvc3NpYmxlVHJhaXRBbGxlbGVzID0gY29sbGVjdEFsbEFsbGVsZXNGb3JUcmFpdCh0cmFpdCwgdHJhaXRSdWxlcyksXG4gICAgICAgICAgICBjaGFyYWN0ZXJpc3RpY0FsbGVsZXMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gYWxsZWxlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7XG4gICAgICAgICAgaWYgKHBvc3NpYmxlVHJhaXRBbGxlbGVzLmluZGV4T2YoYWxsZWxlc1tpXSkgPj0gMCl7XG4gICAgICAgICAgICBjaGFyYWN0ZXJpc3RpY0FsbGVsZXMucHVzaChhbGxlbGVzW2ldKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gbm93IHdvcmsgb3V0IHRoZSBzbWFsbGVzdCBudW1iZXIgb2Ygc3RlcHMgdG8gZ2V0IGZyb20gdGhlcmUgdG8gdGhlIGRlc2lyZWQgY2hhcmFjdGVyaXN0aWNcbiAgICAgICAgdmFyIHBvc3NpYmxlU29sdXRpb25zID0gdHJhaXRSdWxlc1t0cmFpdF1bdGFyZ2V0Q2hhcmFjdGVyaXN0aWNzW3RyYWl0XV0sXG4gICAgICAgICAgICBzaG9ydGVzdFBhdGhMZW5ndGggPSBJbmZpbml0eTtcbiAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwb3NzaWJsZVNvbHV0aW9ucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7XG4gICAgICAgICAgdmFyIHNvbHV0aW9uID0gcG9zc2libGVTb2x1dGlvbnNbaV0uc2xpY2UoKSxcbiAgICAgICAgICAgICAgcGF0aExlbmd0aCA9IDA7XG4gICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpqID0gY2hhcmFjdGVyaXN0aWNBbGxlbGVzLmxlbmd0aDsgaiA8IGpqOyBqKyspe1xuICAgICAgICAgICAgaWYgKHNvbHV0aW9uLmluZGV4T2YoY2hhcmFjdGVyaXN0aWNBbGxlbGVzW2pdKSA9PT0gLTEpe1xuICAgICAgICAgICAgICBwYXRoTGVuZ3RoKys7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzb2x1dGlvbi5zcGxpY2Uoc29sdXRpb24uaW5kZXhPZihjaGFyYWN0ZXJpc3RpY0FsbGVsZXNbal0pLCAxKTsgICAgICAvLyBhbHJlYWR5IG1hdGNoZWQgdGhpcyBvbmUsIGNhbid0IG1hdGNoIGl0IGFnYWluXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHNob3J0ZXN0UGF0aExlbmd0aCA9IChwYXRoTGVuZ3RoIDwgc2hvcnRlc3RQYXRoTGVuZ3RoKSA/IHBhdGhMZW5ndGggOiBzaG9ydGVzdFBhdGhMZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgbW92ZXMgKz0gc2hvcnRlc3RQYXRoTGVuZ3RoO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbW92ZXM7XG59XG5cbi8vIEdvZXMgdGhyb3VnaCB0aGUgdHJhaXRSdWxlcyB0byBmaW5kIG91dCB3aGF0IHVuaXF1ZSBhbGxlbGVzIGFyZSBhc3NvY2lhdGVkIHdpdGggZWFjaCB0cmFpdFxuLy8gRS5nLiBGb3IgXCJ0YWlsXCIgaXQgd2lsbCByZXR1cm4gW1wiVFwiLCBcIlRrXCIsIFwidFwiXVxuZnVuY3Rpb24gY29sbGVjdEFsbEFsbGVsZXNGb3JUcmFpdCh0cmFpdCwgdHJhaXRSdWxlcykge1xuICBpZiAoX3Bvc3NpYmxlQWxsZWxlc0ZvclRyYWl0W3RyYWl0XSkge1xuICAgIHJldHVybiBfcG9zc2libGVBbGxlbGVzRm9yVHJhaXRbdHJhaXRdO1xuICB9XG5cbiAgdmFyIGFsbGVsZXNIYXNoID0ge30sXG4gICAgICBhbGxlbGVzICAgICA9IFtdO1xuICBmb3IgKHZhciBjaGFyYWN0ZXJpc3RpYyBpbiB0cmFpdFJ1bGVzW3RyYWl0XSl7XG4gICAgICBmb3IgKHZhciBwb3NzaWJpbGVBbGxlbGVzQ29tYm8gaW4gdHJhaXRSdWxlc1t0cmFpdF1bY2hhcmFjdGVyaXN0aWNdKSB7XG4gICAgICAgIGlmICh0cmFpdFJ1bGVzW3RyYWl0XVtjaGFyYWN0ZXJpc3RpY10uaGFzT3duUHJvcGVydHkocG9zc2liaWxlQWxsZWxlc0NvbWJvKSl7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gdHJhaXRSdWxlc1t0cmFpdF1bY2hhcmFjdGVyaXN0aWNdW3Bvc3NpYmlsZUFsbGVsZXNDb21ib10ubGVuZ3RoOyBpIDwgaWk7IGkrKykge1xuICAgICAgICAgICAgYWxsZWxlc0hhc2hbdHJhaXRSdWxlc1t0cmFpdF1bY2hhcmFjdGVyaXN0aWNdW3Bvc3NpYmlsZUFsbGVsZXNDb21ib11baV1dID0gMTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgfVxuXG4gIGZvciAodmFyIGFsbGVsZSBpbiBhbGxlbGVzSGFzaCl7XG4gICAgYWxsZWxlcy5wdXNoKGFsbGVsZSk7XG4gIH1cblxuICBfcG9zc2libGVBbGxlbGVzRm9yVHJhaXRbdHJhaXRdID0gYWxsZWxlczsgICAgICAvLyBzdG9yZSBzbyB3ZSBkb24ndCBuZWVkIHRvIHJlY2FsY3VsYXRlIGl0XG4gIHJldHVybiBhbGxlbGVzO1xufVxuXG5mdW5jdGlvbiBjaGVja0RyYWtlKGlZb3VyRHJha2UsIGlUYXJnZXREcmFrZSwgaUhpZGRlbkdlbmVzKSB7XG4gIGNvbnN0IGNoYXJhY3RlcmlzdGljVG9HZW5lTWFwID0ge1xuICAgICAgICAgIFwiYXJtb3JcIjogXCJhcm1vclwiLFxuICAgICAgICAgIFwidGFpbFwiOiBcInRhaWxcIixcbiAgICAgICAgICBcImZvcmVsaW1ic1wiOiBcImZvcmVsaW1ic1wiLFxuICAgICAgICAgIFwiaGluZGxpbWJzXCI6IFwiaGluZGxpbWJzXCIsXG4gICAgICAgICAgXCJob3Juc1wiOiBcImhvcm5zXCIsXG4gICAgICAgICAgXCJub3NlIHNwaWtlXCI6IFwibm9zZVwiLFxuICAgICAgICAgIFwid2luZ3NcIjogXCJ3aW5nc1wiLFxuICAgICAgICAgIFwiY29sb3JcIjogXCJjb2xvclwiLFxuICAgICAgICAgIFwiaGVhbHRoXCI6IFwiYm9nYnJlYXRoXCIsXG4gICAgICAgICAgXCJsaXZlbGluZXNzXCI6IFwiZGlsdXRlXCJcbiAgICAgICAgfTtcbiAgaWYoaVlvdXJEcmFrZS5zZXggIT09IGlUYXJnZXREcmFrZS5zZXgpXG4gICAgcmV0dXJuIGZhbHNlO1xuICBmb3IoY29uc3QgY2ggaW4gaVlvdXJEcmFrZS5waGVub3R5cGUuY2hhcmFjdGVyaXN0aWNzKSB7XG4gICAgY29uc3QgeW91clZhbHVlID0gaVlvdXJEcmFrZS5waGVub3R5cGUuY2hhcmFjdGVyaXN0aWNzW2NoXSxcbiAgICAgICAgICB0YXJnZXRWYWx1ZSA9IGlUYXJnZXREcmFrZS5waGVub3R5cGUuY2hhcmFjdGVyaXN0aWNzW2NoXSxcbiAgICAgICAgICBnZW5lID0gY2hhcmFjdGVyaXN0aWNUb0dlbmVNYXBbY2hdO1xuICAgIGlmKCFpSGlkZGVuR2VuZXMuaGFzKGdlbmUpICYmICh5b3VyVmFsdWUgIT09IHRhcmdldFZhbHVlKSlcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn1cblxuLyplc2xpbnQgbm8tdW51c2VkLXZhcnM6IFsxLCB7IFwidmFyc0lnbm9yZVBhdHRlcm5cIjogXCJyZXNldENoYWxsZW5nZXxuZXh0Q2hhbGxlbmdlfGFkdmFuY2VUcmlhbFwiIH1dKi9cbmNvbnN0IHJlc2V0Q2hhbGxlbmdlID0gZnVuY3Rpb24gcmVzZXRDaGFsbGVuZ2UoKSB7XG4gIHRyaWFsSW5kZXggPSAxO1xuICBtb3ZlQ291bnQgPSAwO1xuICByZXNldERyYWtlcygpO1xufTtcblxuY29uc3QgbmV4dENoYWxsZW5nZSA9IGZ1bmN0aW9uIG5leHRDaGFsbGVuZ2UoKSB7XG4gIGxldCB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZixcbiAgICAgIG5leHRVcmw7XG4gIGlmIChjaGFsbGVuZ2UgPCAyKSB7XG4gICAgbmV4dFVybCA9IHVybC5yZXBsYWNlKGBjaGFsbGVuZ2U9JHtjaGFsbGVuZ2V9YCwgYGNoYWxsZW5nZT0ke2NoYWxsZW5nZSsxfWApO1xuICB9XG4gIGVsc2Uge1xuICAgIGNvbnN0IGNhc2UxSW5kZXggPSB1cmwuaW5kZXhPZignY2FzZS0xJyk7XG4gICAgbmV4dFVybCA9IHVybC5zdWJzdHIoMCwgY2FzZTFJbmRleCk7XG4gIH1cbiAgd2luZG93LmxvY2F0aW9uLmFzc2lnbihuZXh0VXJsKTtcbn07XG5cbmNvbnN0IGFkdmFuY2VUcmlhbCA9IGZ1bmN0aW9uIGFkdmFuY2VUcmlhbCgpIHtcbiAgaWYgKGNoYWxsZW5nZSA+PSAyKSB7XG4gICAgaWYgKHRyaWFsSW5kZXggPj0gdHJpYWxDb3VudCkge1xuICAgICAgc2hvd0FsZXJ0KHRydWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIkNvbmdyYXR1bGF0aW9ucyFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UxOiBcIllvdSd2ZSBjb21wbGV0ZWQgYWxsIHRoZSB0cmlhbHMgaW4gdGhpcyBjaGFsbGVuZ2UuXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvbjogXCJHbyBiYWNrIHRvIHRoZSBDYXNlIExvZ1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb2tDYWxsYmFjazogXCJuZXh0Q2hhbGxlbmdlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnlCdXR0b246IFwiVHJ5IEFnYWluXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnlDYWxsYmFjazogXCJyZXNldENoYWxsZW5nZVwiXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgICsrdHJpYWxJbmRleDtcbiAgfVxuICBtb3ZlQ291bnQgPSAwO1xuICByZXNldERyYWtlcygpO1xufTtcblxuZnVuY3Rpb24gc2hvd0FsZXJ0KGlTaG93LCBpT3B0aW9ucykge1xuICBjb25zdCBkaXNwbGF5TW9kZSA9IGlTaG93ID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgaWYgKGlTaG93KSB7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbGVydC10aXRsZVwiKS5pbm5lckhUTUwgPSBpT3B0aW9ucy50aXRsZSB8fCBcIlwiO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtbWVzc2FnZTFcIikuaW5uZXJIVE1MID0gaU9wdGlvbnMubWVzc2FnZTEgfHwgXCJcIjtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LW1lc3NhZ2UyXCIpLmlubmVySFRNTCA9IGlPcHRpb25zLm1lc3NhZ2UyIHx8IFwiXCI7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbGVydC1vay1idXR0b25cIikuaW5uZXJIVE1MID0gaU9wdGlvbnMub2tCdXR0b24gfHwgXCJcIjtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LW9rLWJ1dHRvblwiKS5zdHlsZS5kaXNwbGF5ID0gaU9wdGlvbnMub2tCdXR0b24gPyAnYmxvY2snIDogJ25vbmUnO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtb2stYnV0dG9uXCIpLmRhdGFzZXQub2tDYWxsYmFjayA9IGlPcHRpb25zLm9rQ2FsbGJhY2sgfHwgJyc7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbGVydC10cnktYnV0dG9uXCIpLmlubmVySFRNTCA9IGlPcHRpb25zLnRyeUJ1dHRvbiB8fCBcIlwiO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtdHJ5LWJ1dHRvblwiKS5zdHlsZS5kaXNwbGF5ID0gaU9wdGlvbnMudHJ5QnV0dG9uID8gJ2Jsb2NrJyA6ICdub25lJztcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFsZXJ0LXRyeS1idXR0b25cIikuZGF0YXNldC50cnlDYWxsYmFjayA9IGlPcHRpb25zLnRyeUNhbGxiYWNrIHx8ICcnO1xuICB9XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwib3ZlcmxheVwiKS5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheU1vZGU7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtd3JhcHBlclwiKS5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheU1vZGU7XG59XG5cbmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdC1kcmFrZS1idXR0b25cIikub25jbGljayA9IGZ1bmN0aW9uKCkge1xuICBzaG93RHJha2VGb3JDb25maXJtYXRpb24gPSB0cnVlO1xuICByZW5kZXIoKTtcblxuICBpZiAobnVtYmVyT2ZNb3Zlc1RvUmVhY2hQaGVub3R5cGUoeW91ckRyYWtlLCB0YXJnZXREcmFrZSkgPT09IDApIHtcbiAgICBpZiAoY2hhbGxlbmdlIDw9IDEpIHtcbiAgICAgIHNob3dBbGVydCh0cnVlLCB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiR29vZCB3b3JrIVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTE6IFwiVGhlIGRyYWtlIHlvdSBoYXZlIGNyZWF0ZWQgbWF0Y2hlcyB0aGUgdGFyZ2V0IGRyYWtlLlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb2tCdXR0b246IFwiTmV4dCBDaGFsbGVuZ2VcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQ2FsbGJhY2s6IFwibmV4dENoYWxsZW5nZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5QnV0dG9uOiBcIlRyeSBBZ2FpblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5Q2FsbGJhY2s6IFwicmVzZXRDaGFsbGVuZ2VcIlxuICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHNob3dBbGVydCh0cnVlLCB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiR29vZCB3b3JrIVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTE6IFwiVGhlIGRyYWtlIHlvdSBoYXZlIGNyZWF0ZWQgbWF0Y2hlcyB0aGUgdGFyZ2V0IGRyYWtlLlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb2tCdXR0b246IFwiT0tcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQ2FsbGJhY2s6IFwiYWR2YW5jZVRyaWFsXCJcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgc2hvd0FsZXJ0KHRydWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJUaGF0J3Mgbm90IHRoZSBkcmFrZSFcIixcbiAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlMTogXCJUaGUgZHJha2UgeW91IGhhdmUgY3JlYXRlZCBkb2Vzbid0IG1hdGNoIHRoZSB0YXJnZXQgZHJha2UuXFxuUGxlYXNlIHRyeSBhZ2Fpbi5cIixcbiAgICAgICAgICAgICAgICAgICAgICB0cnlCdXR0b246IFwiVHJ5IEFnYWluXCJcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgcmVuZGVyKCk7XG4gIH1cbn07XG5cbmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtb2stYnV0dG9uXCIpLm9uY2xpY2sgPSBmdW5jdGlvbihldnQpIHtcbiAgc2hvd0FsZXJ0KGZhbHNlKTtcbiAgc2hvd0RyYWtlRm9yQ29uZmlybWF0aW9uID0gZmFsc2U7XG4gIGlmIChldnQudGFyZ2V0LmRhdGFzZXQub2tDYWxsYmFjayAmJiB3aW5kb3dbZXZ0LnRhcmdldC5kYXRhc2V0Lm9rQ2FsbGJhY2tdKVxuICAgIHdpbmRvd1tldnQudGFyZ2V0LmRhdGFzZXQub2tDYWxsYmFja10uY2FsbCgpO1xuICByZW5kZXIoKTtcbn07XG5cbmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYWxlcnQtdHJ5LWJ1dHRvblwiKS5vbmNsaWNrID0gZnVuY3Rpb24oZXZ0KSB7XG4gIHNob3dBbGVydChmYWxzZSk7XG4gIHNob3dEcmFrZUZvckNvbmZpcm1hdGlvbiA9IGZhbHNlO1xuICBpZiAoZXZ0LnRhcmdldC5kYXRhc2V0LnRyeUNhbGxiYWNrICYmIHdpbmRvd1tldnQudGFyZ2V0LmRhdGFzZXQudHJ5Q2FsbGJhY2tdKVxuICAgIHdpbmRvd1tldnQudGFyZ2V0LmRhdGFzZXQudHJ5Q2FsbGJhY2tdLmNhbGwoKTtcbiAgcmVuZGVyKCk7XG59O1xuXG5yZXNldERyYWtlcygpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
